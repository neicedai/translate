<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>聊斋志异 · 逐字注释生成器</title>
  <style>
    :root{--bg:#070c13;--card:#101822;--border:#1b2634;--text:#e8efff;--muted:#8da0bf;--accent:#4da3ff;--chip:#192537;--success:#34d399;--warn:#fbbf24;--error:#f87171;--mono:#1b2535;}
    *{box-sizing:border-box}
    body{margin:0;font-family:"Noto Sans SC","PingFang SC","Microsoft YaHei",system-ui,-apple-system,Segoe UI,sans-serif;background:linear-gradient(180deg,#05080d,#0c131d);color:var(--text);min-height:100vh}
    header{padding:28px 22px 18px;max-width:1100px;margin:0 auto;display:flex;flex-direction:column;gap:12px}
    header h1{margin:0;font-size:28px;font-weight:700;letter-spacing:.02em}
    header p{margin:0;font-size:15px;color:var(--muted);line-height:1.7}
    code{font-family:"JetBrains Mono","Fira Code",monospace;background:rgba(255,255,255,.06);padding:2px 6px;border-radius:6px;color:var(--accent)}

    .card{max-width:1100px;margin:0 auto 20px;background:var(--card);border:1px solid var(--border);border-radius:20px;padding:18px 22px;display:flex;flex-direction:column;gap:16px}
    .card h2{margin:0;font-size:20px;font-weight:600}
    label{display:flex;flex-direction:column;gap:6px;font-size:13px;color:var(--muted)}
    input{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0a111a;color:var(--text);font-size:14px}
    textarea{width:100%;min-height:120px;border-radius:12px;border:1px solid var(--border);background:#0a111a;color:var(--text);padding:12px;font-size:13px;line-height:1.6}
    textarea[readonly]{opacity:.85}
    button{padding:10px 16px;border-radius:12px;border:1px solid var(--border);background:var(--mono);color:var(--text);cursor:pointer;font-size:13px;transition:all .15s ease}
    button.primary{background:var(--accent);color:#021f39;border:1px solid rgba(255,255,255,.08);font-weight:600}
    button.ghost{background:transparent}
    button:disabled{opacity:.55;cursor:not-allowed}
    .btn-row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .status{font-size:13px;color:var(--muted)}

    .file-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px}
    .file-item{border:1px solid var(--border);border-radius:16px;padding:14px 16px;display:flex;flex-direction:column;gap:8px;background:#0c1521;transition:border .2s}
    .file-item.selected{border-color:rgba(77,163,255,.8);box-shadow:0 0 0 1px rgba(77,163,255,.35)}
    .file-title{font-size:15px;font-weight:600;margin:0}
    .file-meta{font-size:12px;color:var(--muted);display:flex;justify-content:space-between;align-items:center}
    .file-status{font-size:12px;color:var(--muted)}
    .file-status.success{color:var(--success)}
    .file-status.error{color:var(--error)}

    .result-grid{display:flex;flex-direction:column;gap:18px}
    .result-card{border:1px solid var(--border);background:#0c1521;border-radius:20px;padding:20px;display:flex;flex-direction:column;gap:16px}
    .result-card header{display:flex;flex-direction:column;gap:8px}
    .result-card h3{margin:0;font-size:19px;font-weight:600}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:var(--chip);color:var(--muted);font-size:12px;border:1px solid var(--border)}
    .line-pair{display:flex;flex-direction:column;gap:4px;padding:10px 12px;border-radius:12px;background:rgba(77,163,255,.06);border:1px solid rgba(77,163,255,.12)}
    .line-pair strong{color:var(--accent);font-weight:600}
    .line-pair p{margin:0;font-size:13px;line-height:1.75;white-space:pre-wrap}
    .section{display:flex;flex-direction:column;gap:10px}
    .section h4{margin:0;font-size:16px;color:var(--accent)}
    .section p{margin:0;font-size:13px;line-height:1.8;white-space:pre-wrap}

    .downloads{display:flex;gap:10px;flex-wrap:wrap}
    .downloads a{padding:8px 14px;border-radius:999px;border:1px solid var(--border);background:rgba(77,163,255,.12);color:var(--text);font-size:12px;text-decoration:none}

    .nav-preview{display:flex;flex-direction:column;gap:10px}
    .nav-preview[hidden]{display:none}
  </style>
</head>
<body>
  <header>
    <h1>《聊斋志异》文言文 · DeepSeek 逐字注释批量生成</h1>
    <p>
      本页会读取 <code>book</code> 目录下的所有 <code>.txt</code> 文件，选择篇目后调用 DeepSeek API，生成与 <code>tran.html</code> 类似的逐字与词组释义。
      自动注释的结果会与原文件中的白话文、点评整合导出为新的 HTML 页面，并可额外生成一个导航页便于离线浏览。
    </p>
  </header>

  <section class="card" aria-label="API 配置">
    <h2>第一步：配置 DeepSeek 接口</h2>
    <div class="file-list" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));">
      <label>API 地址
        <input id="apiUrl" placeholder="https://api.deepseek.com/v1/chat/completions" />
      </label>
      <label>API Key
        <input id="apiKey" type="password" placeholder="Bearer ..." />
      </label>
      <label>模型名称
        <input id="apiModel" placeholder="deepseek-chat" />
      </label>
    </div>
    <div class="btn-row">
      <button id="saveApi" class="primary">保存配置（仅存浏览器）</button>
      <span class="status" id="configStatus"></span>
    </div>
  </section>

  <section class="card" aria-label="篇目选择">
    <h2>第二步：选择要处理的篇目</h2>
    <div class="file-list" id="fileList"></div>
    <div class="btn-row">
      <button id="selectAll">全选</button>
      <button id="clearSelection" class="ghost">清除选择</button>
      <button id="generateSelected" class="primary">生成选中篇目的逐字注释页面</button>
      <span class="status" id="globalStatus"></span>
    </div>
  </section>

  <section class="card" aria-label="生成结果">
    <h2>第三步：下载注释页面与导航</h2>
    <div id="results" class="result-grid" aria-live="polite"></div>
    <div id="navSection" class="nav-preview" hidden>
      <h3>自动导航页</h3>
      <p class="status">下载各篇注释后，可同时保存此导航页（含所有链接）。</p>
      <div class="downloads">
        <a id="navDownload" download="liaozhai-book-index.html">下载导航页 HTML</a>
      </div>
      <textarea id="navPreview" readonly></textarea>
    </div>
  </section>

  <script type="module">
    const $ = (sel, ctx=document) => ctx.querySelector(sel);
    const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
    const API_STORE_KEY = 'liaozhai_ctx_api';
    const SCRIPT_PLACEHOLDER = '__SCRIPT_END__';
    const SCRIPT_CLOSING = '</scr' + 'ipt>';

    const state = {
      manifest: [],
      generated: [],
      downloadUrls: new Map(),
      navUrl: null
    };
    const PUNCT_RE = /[，。！？、；：、“”‘’（）《》〈〉【】『』]/;

    function escapeHtml(str=''){
      return str.replace(/[&<>"']/g, ch => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      })[ch] || ch);
    }

    function loadApiConfig(){
      try{
        const raw = localStorage.getItem(API_STORE_KEY) || localStorage.getItem(API_STORE_KEY + '_backup') || '{}';
        const cfg = JSON.parse(raw);
        $('#apiUrl').value = cfg.url || '';
        $('#apiKey').value = cfg.key || '';
        $('#apiModel').value = cfg.model || '';
        return cfg;
      }catch(err){
        console.warn('load api config failed', err);
        return {};
      }
    }

    function saveApiConfig(){
      const cfg = {
        url: $('#apiUrl').value.trim(),
        key: $('#apiKey').value.trim(),
        model: $('#apiModel').value.trim()
      };
      localStorage.setItem(API_STORE_KEY, JSON.stringify(cfg));
      localStorage.setItem(API_STORE_KEY + '_backup', JSON.stringify(cfg));
      const status = $('#configStatus');
      status.textContent = '配置已保存';
      setTimeout(() => status.textContent = '', 3000);
      return cfg;
    }

    $('#saveApi').addEventListener('click', saveApiConfig);

    function getApiConfig(){
      const url = $('#apiUrl').value.trim();
      const key = $('#apiKey').value.trim();
      const model = $('#apiModel').value.trim() || 'deepseek-chat';
      if(!url || !key){
        throw new Error('请先填写 API 地址与 Key');
      }
      return { url, key, model };
    }

    async function fetchManifest(){
      const res = await fetch('book/manifest.json');
      if(!res.ok) throw new Error('无法读取 book/manifest.json');
      return res.json();
    }

    function renderManifest(list){
      const wrap = $('#fileList');
      wrap.innerHTML = '';
      list.forEach((item, index) => {
        const div = document.createElement('label');
        div.className = 'file-item';
        div.innerHTML = `
          <div class="btn-row" style="justify-content:space-between;align-items:flex-start">
            <div style="display:flex;align-items:center;gap:8px">
              <input type="checkbox" data-index="${index}" />
              <span class="file-title">${escapeHtml(item.title || item.file)}</span>
            </div>
            <span class="chip">${escapeHtml(item.file)}</span>
          </div>
          <div class="file-meta">
            <span>点击复选框加入生成队列</span>
            <span class="file-status" data-role="status"></span>
          </div>
        `;
        wrap.appendChild(div);
        const checkbox = div.querySelector('input[type="checkbox"]');
        checkbox.addEventListener('change', () => {
          div.classList.toggle('selected', checkbox.checked);
        });
      });
    }

    function getSelectedIndexes(){
      return $$('#fileList input[type="checkbox"]').filter(cb => cb.checked).map(cb => Number(cb.dataset.index));
    }

    $('#selectAll').addEventListener('click', () => {
      $$('#fileList input[type="checkbox"]').forEach(cb => {
        cb.checked = true;
        cb.dispatchEvent(new Event('change'));
      });
    });

    $('#clearSelection').addEventListener('click', () => {
      $$('#fileList input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
        cb.dispatchEvent(new Event('change'));
      });
    });

    function parseContent(text){
      const whiteMark = '【白话文翻译】';
      const commentMark = '【点评】';
      const idxWhite = text.indexOf(whiteMark);
      const idxComment = text.indexOf(commentMark);
      let original = text;
      let vernacular = '';
      let comment = '';
      if(idxWhite !== -1){
        original = text.slice(0, idxWhite);
        if(idxComment !== -1){
          vernacular = text.slice(idxWhite + whiteMark.length, idxComment);
          comment = text.slice(idxComment + commentMark.length);
        }else{
          vernacular = text.slice(idxWhite + whiteMark.length);
        }
      }
      const rawLines = original.split(/\r?\n+/).map(s => s.trim());
      const originalLines = rawLines
        .map(line => line.replace(/^【原文】\s*/, '').trim())
        .filter(Boolean)
        .filter(line => !/^【.+?】$/.test(line) && !/^标题[:：]/.test(line));
      const originalText = originalLines.join('\n');
      return {
        originalText,
        originalLines,
        vernacular: vernacular.trim(),
        comment: comment.trim()
      };
    }

    function getStatusEl(index){
      return $$('#fileList .file-item')[index]?.querySelector('[data-role="status"]') || null;
    }

    async function translateWithDeepseek(cfg, meta, content){
      const req = {
        title: meta.title || meta.file,
        lines: content.originalLines.map((text, index) => ({
          index,
          text,
          charList: Array.from(text).map((ch, i) => ({ i, ch }))
        }))
      };
      const systemPrompt = [
        '你是严谨的文言注释助手，请对提供的每一行文言文生成逐字及重点词组释义。',
        '要求：',
        '1. 仅使用给定的 charList 中的字符与索引，禁止新增或改写原文；',
        '2. 若能判断词组释义，请在 phrases 中记录起止索引，并给出简明释义；',
        '3. 对缺乏明确释义的字词可留空；',
        '4. 不要输出整段白话文翻译；',
        '5. 严格只返回 JSON，格式：{"title":"注释标题(可选)","summary":"可选概述","lines":[{"index":行号,"chars":[{"i":索引,"p":"拼音(可选)","g":"释义(可选)"}],"phrases":[{"s":起,"e":止,"p":"拼音(可选)","g":"释义(可选)"}]}]}'
      ].join('\n');
      const body = {
        model: cfg.model,
        messages: [
          {
            role: 'system',
            content: systemPrompt
          },
          {
            role: 'user',
            content: JSON.stringify(req)
          }
        ],
        temperature: 0.2,
        response_format: { type: 'json_object' }
      };
      const res = await fetch(cfg.url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + cfg.key
        },
        body: JSON.stringify(body)
      });
      if(!res.ok){
        const txt = await res.text();
        throw new Error('HTTP ' + res.status + ': ' + txt.slice(0, 180));
      }
      const data = await res.json();
      let payload = data;
      if(data?.choices?.[0]?.message?.content){
        try{
          payload = JSON.parse(data.choices[0].message.content);
        }catch(err){
          console.warn('parse response failed', err);
        }
      }
      return payload;
    }

    function pickString(source, keys){
      if(!source) return '';
      for(const key of keys){
        if(!Object.prototype.hasOwnProperty.call(source, key)) continue;
        const value = source[key];
        if(typeof value === 'string'){
          const trimmed = value.trim();
          if(trimmed) return trimmed;
        }
      }
      return '';
    }

    function pickInteger(source, keys){
      if(!source) return null;
      for(const key of keys){
        if(!Object.prototype.hasOwnProperty.call(source, key)) continue;
        const value = Number(source[key]);
        if(Number.isInteger(value)){
          return value;
        }
      }
      return null;
    }

    function normaliseTranslation(content, payload){
      const lineMap = new Map();
      if(Array.isArray(payload?.lines)){
        payload.lines.forEach(item => {
          if(!item) return;
          const idx = pickInteger(item, ['index', 'lineIndex', 'line']);
          if(idx === null) return;
          lineMap.set(idx, item);
        });
      }
      const lines = content.originalLines.map((text, index) => {
        const charArr = Array.from(text);
        const chars = charArr.map(ch => ({ c: ch, p: '', g: '' }));
        const phrases = [];
        const payloadLine = lineMap.get(index);
        let indexShift = 0;
        let shiftResolved = false;
        const usedIndices = new Set();
        function findCharIndex(entryChar, preferredIndex=null, trackUsage=true){
          if(!entryChar) return -1;
          const candidates = [];
          charArr.forEach((ch, arrIdx) => {
            if(ch !== entryChar) return;
            if(trackUsage && usedIndices.has(arrIdx)) return;
            candidates.push(arrIdx);
          });
          if(!candidates.length && trackUsage){
            return findCharIndex(entryChar, preferredIndex, false);
          }
          if(!candidates.length) return -1;
          if(typeof preferredIndex === 'number' && Number.isFinite(preferredIndex)){
            let best = candidates[0];
            let bestDelta = Math.abs(preferredIndex - best);
            for(let i = 1; i < candidates.length; i++){
              const idxCandidate = candidates[i];
              const delta = Math.abs(preferredIndex - idxCandidate);
              if(delta < bestDelta){
                best = idxCandidate;
                bestDelta = delta;
              }
            }
            return best;
          }
          return candidates[0];
        }
        if(payloadLine && Array.isArray(payloadLine.chars)){
          for(const entry of payloadLine.chars){
            if(!entry) continue;
            const rawIndex = pickInteger(entry, ['i', 'index', 'idx', 'position']);
            const entryChar = pickString(entry, ['ch', 'char', 'character', 'c', 'text', 'value']);
            if(rawIndex === null || !entryChar) continue;
            const actualIndex = findCharIndex(entryChar, rawIndex, false);
            if(actualIndex === -1) continue;
            indexShift = rawIndex - actualIndex;
            shiftResolved = true;
            break;
          }
        }
        function normaliseIndex(rawIndex, entryChar, opts={}){
          if(rawIndex === null) return null;
          let candidate = rawIndex - (shiftResolved ? indexShift : 0);
          if(candidate < 0 || candidate >= chars.length){
            if(entryChar){
              const fallback = findCharIndex(entryChar, candidate, opts.trackUsage !== false);
              if(fallback === -1) return null;
              candidate = fallback;
            }else if(shiftResolved && candidate === chars.length && chars.length){
              candidate = chars.length - 1;
            }else{
              return null;
            }
          }
          if(entryChar && charArr[candidate] !== entryChar){
            const fallback = findCharIndex(entryChar, candidate, opts.trackUsage !== false);
            if(fallback === -1) return null;
            candidate = fallback;
          }
          return candidate;
        }
        if(payloadLine){
          if(Array.isArray(payloadLine.chars)){
            payloadLine.chars.forEach(entry => {
              if(!entry) return;
              const rawIndex = pickInteger(entry, ['i', 'index', 'idx', 'position']);
              const entryChar = pickString(entry, ['ch', 'char', 'character', 'c', 'text', 'value']);
              const i = normaliseIndex(rawIndex, entryChar);
              if(i === null || i < 0 || i >= chars.length) return;
              const pVal = pickString(entry, ['p', 'pinyin', 'py']);
              if(pVal){
                chars[i].p = pVal;
              }
              const gVal = pickString(entry, ['g', 'gloss', 'meaning', 'translation', 'explanation', 'note', 'interpretation', 'definition', 'def']);
              if(gVal){
                chars[i].g = gVal;
              }
              usedIndices.add(i);
            });
          }
          if(Array.isArray(payloadLine.phrases)){
            payloadLine.phrases.forEach(ph => {
              if(!ph) return;
              let s = normaliseIndex(pickInteger(ph, ['s', 'start', 'from', 'begin', 'beginIndex']), null, { trackUsage: false });
              let e = normaliseIndex(pickInteger(ph, ['e', 'end', 'to', 'finish', 'stop', 'endIndex']), null, { trackUsage: false });
              if(s === null || e === null) return;
              if(s > e) [s, e] = [e, s];
              if(s < 0 || e >= chars.length) return;
              phrases.push({
                s,
                e,
                p: pickString(ph, ['p', 'pinyin', 'py']),
                g: pickString(ph, ['g', 'gloss', 'meaning', 'translation', 'explanation', 'note', 'interpretation', 'definition', 'def'])
              });
            });
          }
        }
        return { text, chars, phrases };
      });
      const summary = pickString(payload, ['summary', 'desc', 'description']);
      const title = pickString(payload, ['title', 'name', 'heading']);
      return { title, lines, summary };
    }

    function buildPageHtml(meta, content, translation){
      const docTitle = translation.title || (meta.title || meta.file.replace(/\.txt$/i, ''));
      const safeDocTitle = escapeHtml(docTitle);
      const now = new Date();
      const stamp = now.toLocaleString();
      const vernacularHtml = content.vernacular ? escapeHtml(content.vernacular).replace(/\n/g, '<br />') : '<em>原文件未提供白话文内容。</em>';
      const commentHtml = content.comment ? escapeHtml(content.comment).replace(/\n/g, '<br />') : '<em>原文件未提供点评。</em>';
      const originalHtml = content.originalText ? escapeHtml(content.originalText).replace(/\n/g, '<br />') : '';
      const summaryHtml = translation.summary ? `<p class="hero-summary">${escapeHtml(translation.summary)}</p>` : '';
      const totalChars = translation.lines.reduce((sum, line) => sum + line.chars.length, 0);
      const annotatedChars = translation.lines.reduce((sum, line) => sum + line.chars.filter(cell => cell.g || cell.p).length, 0);
      const phraseCount = translation.lines.reduce((sum, line) => sum + line.phrases.length, 0);
      const lineCount = translation.lines.length;
      const coveragePercent = totalChars ? Math.round((annotatedChars / totalChars) * 100) : 0;
      const annotatedChip = totalChars
        ? `释义覆盖：${annotatedChars}/${totalChars} 字（约 ${coveragePercent}%）`
        : '暂无释义覆盖统计';
      const textPanelHtml = translation.lines.map((line, lineIndex) => {
        const charsHtml = Array.from(line.text || '').map((ch, charIndex) => {
          const classes = ['char'];
          if(PUNCT_RE.test(ch)){
            classes.push('punct');
          }
          const safeChar = ch === ' ' ? '&nbsp;' : escapeHtml(ch);
          return `<span class="${classes.join(' ')}" data-line="${lineIndex}" data-index="${charIndex}">${safeChar}</span>`;
        }).join('');
        return `<div class="line" data-line="${lineIndex}">${charsHtml}</div>`;
      }).join('');
      const dataPayload = {
        meta: {
          file: meta.file,
          generatedAt: stamp
        },
        lines: translation.lines.map((line, index) => ({
          index,
          text: line.text,
          chars: line.chars.map(cell => ({
            c: cell.c,
            p: cell.p || '',
            g: cell.g || ''
          })),
          phrases: line.phrases.map(ph => ({
            s: ph.s,
            e: ph.e,
            p: ph.p || '',
            g: ph.g || ''
          }))
        }))
      };
      const dataScript = JSON.stringify(dataPayload).replace(/</g, '\\u003c');
      let html = `<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>${safeDocTitle} · 逐字注释</title>
  <style>
    :root{
      --bg:#05080f;
      --card:#101722;
      --surface:#0b111b;
      --border:#1a2433;
      --text:#e8eef9;
      --muted:#91a3c3;
      --accent:#4da3ff;
      --chip:#1a2536;
      --highlight:#1f2a3c;
      --yellow:#ffd166;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:"Noto Sans SC","PingFang SC","Microsoft YaHei",system-ui,-apple-system,Segoe UI,sans-serif;background:linear-gradient(180deg,#05080f,#0d1420);color:var(--text)}
    .container{max-width:1120px;margin:0 auto;padding:32px 22px 40px;display:flex;flex-direction:column;gap:22px}
    .hero{display:flex;flex-direction:column;gap:16px;background:var(--card);border:1px solid var(--border);border-radius:22px;padding:24px 26px;box-shadow:0 24px 60px rgba(5,12,24,.35)}
    .hero h1{margin:6px 0 0;font-size:28px;letter-spacing:.01em}
    .hero .breadcrumb{margin:0;color:var(--muted);font-size:13px;letter-spacing:.08em;text-transform:uppercase}
    .hero-summary{margin:6px 0 0;color:var(--muted);font-size:14px;line-height:1.7}
    .chip-row{display:flex;flex-wrap:wrap;gap:10px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:999px;background:var(--chip);color:var(--muted);border:1px solid var(--border);font-size:12px}
    kbd{display:inline-block;padding:2px 6px;border-radius:6px;background:var(--surface);border:1px solid var(--border);font-size:12px;color:var(--muted)}
    .layout{display:grid;grid-template-columns:minmax(0,1.28fr) minmax(0,0.72fr);gap:22px;align-items:start}
    .card{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:20px 22px;display:flex;flex-direction:column;gap:14px}
    .card-head{display:flex;flex-direction:column;gap:4px}
    .card-head h2{margin:0;font-size:20px;font-weight:600;color:var(--accent)}
    .card-head .muted{color:var(--muted);font-size:13px;margin:0}
    .text-panel{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:18px;height:70vh;overflow:auto;box-shadow:inset 0 0 0 1px rgba(77,163,255,.05)}
    .line{margin-bottom:16px;font-size:20px;line-height:1.95}
    .line:last-child{margin-bottom:0}
    .char{display:inline-block;padding:4px 8px;margin:0 2px;border-radius:10px;cursor:pointer;transition:background .15s ease,color .15s ease}
    .char:hover{background:rgba(77,163,255,.12)}
    .char.active{background:rgba(77,163,255,.22);outline:1px dashed rgba(77,163,255,.32)}
    .char.punct{opacity:.55;cursor:default;pointer-events:none}
    .info-grid{display:grid;grid-template-columns:90px 1fr;gap:12px;font-size:14px;align-items:flex-start}
    .info-grid dt{color:var(--muted);margin:0}
    .info-grid dd{margin:0;min-height:24px;line-height:1.7;white-space:pre-wrap;word-break:break-word}
    .info-grid .placeholder{color:var(--muted);font-style:italic}
    .prose{font-size:15px;line-height:1.9;color:var(--text);background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:18px;white-space:pre-wrap;word-break:break-word}
    footer{text-align:center;color:var(--muted);font-size:12px;padding-top:10px}
    .bubble{position:fixed;display:none;max-width:320px;background:rgba(11,17,27,.98);border:1px solid rgba(77,163,255,.25);border-radius:14px;padding:14px 16px;box-shadow:0 18px 42px rgba(3,8,16,.55);z-index:9999;pointer-events:none;backdrop-filter:blur(4px)}
    .bubble .b-hd{display:flex;align-items:baseline;gap:10px;margin-bottom:6px}
    .bubble .b-char{font-size:20px;font-weight:700}
    .bubble .b-pinyin{font-size:14px;color:var(--yellow)}
    .bubble .b-scope{margin-left:auto;padding:2px 8px;border-radius:999px;background:rgba(77,163,255,.15);border:1px solid rgba(77,163,255,.3);color:var(--accent);font-size:12px;letter-spacing:.04em}
    .bubble .b-gloss{font-size:13px;color:var(--text);line-height:1.65}
    .bubble .b-empty{color:var(--muted);font-style:italic}
    .section-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:18px}
    @media (max-width:960px){
      .layout{grid-template-columns:1fr}
      .text-panel{height:auto;max-height:70vh}
    }
    @media (max-width:640px){
      .container{padding:24px 16px 34px}
      .hero{padding:20px}
      .text-panel{font-size:18px}
      .info-grid{grid-template-columns:80px 1fr}
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="hero">
      <div>
        <p class="breadcrumb">聊斋志异 · 自动注释</p>
        <h1>${safeDocTitle}</h1>
        ${summaryHtml}
      </div>
      <div class="chip-row">
        <span class="chip">生成时间：${escapeHtml(stamp)}</span>
        <span class="chip">来源文件：${escapeHtml(meta.file)}</span>
        <span class="chip">共 ${lineCount} 行</span>
        <span class="chip">词组注释：${phraseCount} 处</span>
        <span class="chip">${escapeHtml(annotatedChip)}</span>
      </div>
    </header>
    <main class="layout">
      <section class="card">
        <div class="card-head">
          <h2>逐字点读区</h2>
          <p class="muted">点击下方文字查看对应的单字或词组释义，若命中词组会自动高亮整段。</p>
        </div>
        <div class="text-panel" id="textPanel" aria-live="polite">${textPanelHtml}</div>
      </section>
      <aside class="card">
        <div class="card-head">
          <h2>释义详情</h2>
          <p class="muted">可按 <kbd>Esc</kbd> 清除选中。</p>
        </div>
        <dl class="info-grid">
          <dt>类型</dt><dd id="infoScope" class="placeholder">点击左侧文字开始</dd>
          <dt>内容</dt><dd id="infoTarget">—</dd>
          <dt>拼音</dt><dd id="infoPinyin">—</dd>
          <dt>释义</dt><dd id="infoGloss">—</dd>
        </dl>
      </aside>
    </main>
    <section class="section-grid">
      <article class="card">
        <div class="card-head">
          <h2>原文</h2>
          <p class="muted">保留原书分行便于对照。</p>
        </div>
        <div class="prose">${originalHtml}</div>
      </article>
      <article class="card">
        <div class="card-head">
          <h2>原书白话</h2>
          <p class="muted">生成内容与原文同步，若原文无白话会提示。</p>
        </div>
        <div class="prose">${vernacularHtml}</div>
      </article>
      <article class="card">
        <div class="card-head">
          <h2>原书点评</h2>
          <p class="muted">若原文件缺少点评将显示提示。</p>
        </div>
        <div class="prose">${commentHtml}</div>
      </article>
    </section>
    <footer>本页面由《聊斋志异》逐字注释生成器自动生成，可离线保存长期查看。</footer>
  </div>
  <div id="bubble" class="bubble" role="status" aria-hidden="true"></div>
  <script>window.PAGE_DATA=${dataScript};${SCRIPT_PLACEHOLDER}
  <script>
    (function(){
      const data = window.PAGE_DATA || { lines: [] };
      const panel = document.getElementById('textPanel');
      const infoScope = document.getElementById('infoScope');
      const infoTarget = document.getElementById('infoTarget');
      const infoPinyin = document.getElementById('infoPinyin');
      const infoGloss = document.getElementById('infoGloss');
      const bubble = document.getElementById('bubble');
      const punctuationRe = /[，。！？、；：、“”‘’（）《》〈〉【】『』]/;
      function escapeHtml(str){
        return String(str ?? '').replace(/[&<>"']/g, ch => {
          switch(ch){
            case '&':
              return '&amp;';
            case '<':
              return '&lt;';
            case '>':
              return '&gt;';
            case '"':
              return '&quot;';
            case '\'':
              return '&#39;';
            default:
              return ch;
          }
        });
      }
      function clearActive(){
        if(!panel) return;
        panel.querySelectorAll('.char.active').forEach(el => el.classList.remove('active'));
      }
      function setInfoField(el, value, fallback='—'){
        if(!el) return;
        const raw = typeof value === 'string' ? value.trim() : '';
        const text = raw && raw !== '—' ? raw : '';
        if(text){
          el.textContent = text;
          el.classList.remove('placeholder');
        }else{
          el.textContent = fallback;
          el.classList.add('placeholder');
        }
      }
      function updateInfo(payload){
        const scopeText = payload?.scope && payload.scope !== '—' ? payload.scope : '';
        const titleText = payload?.title && payload.title !== '—' ? payload.title : '';
        setInfoField(infoScope, scopeText);
        setInfoField(infoTarget, titleText);
        setInfoField(infoPinyin, payload?.pinyin || '');
        setInfoField(infoGloss, payload?.gloss || '');
      }
      function resetInfo(){
        if(infoScope){
          infoScope.textContent = '点击左侧文字开始';
          infoScope.classList.add('placeholder');
        }
        setInfoField(infoTarget, '');
        setInfoField(infoPinyin, '');
        setInfoField(infoGloss, '');
      }
      function getLine(lineIndex){
        return data.lines[lineIndex] || { text: '', chars: [], phrases: [] };
      }
      function getPhrase(lineIndex, charIndex){
        const line = getLine(lineIndex);
        return (line.phrases || []).find(ph => ph.s <= charIndex && ph.e >= charIndex) || null;
      }
      function getPhraseText(lineIndex, start, end){
        const line = getLine(lineIndex);
        return Array.from(line.text || '').slice(start, end + 1).join('');
      }
      function highlightRange(lineIndex, start, end){
        if(!panel) return;
        const lineEl = panel.querySelector('.line[data-line="' + lineIndex + '"]');
        if(!lineEl) return;
        for(let i = start; i <= end; i++){
          const span = lineEl.querySelector('.char[data-index="' + i + '"]');
          if(span) span.classList.add('active');
        }
      }
      function showBubble(el, payload){
        if(!bubble || !el) return;
        const glossHtml = payload.gloss ? escapeHtml(payload.gloss).replace(/\n/g, '<br />') : '<span class="b-empty">暂无释义</span>';
        const scopeTag = payload.scope && payload.scope !== '—' ? '<span class="b-scope">' + escapeHtml(payload.scope) + '</span>' : '';
        bubble.innerHTML = '<div class="b-hd"><span class="b-char">' + escapeHtml(payload.title || '—') + '</span><span class="b-pinyin">' + escapeHtml(payload.pinyin || '—') + '</span>' + scopeTag + '</div><div class="b-gloss">' + glossHtml + '</div>';
        bubble.style.display = 'block';
        requestAnimationFrame(() => {
          const rect = el.getBoundingClientRect();
          const pad = 10;
          let left = rect.left + window.scrollX;
          const top = rect.bottom + window.scrollY + pad;
          const maxLeft = window.scrollX + window.innerWidth - bubble.offsetWidth - 16;
          if(left > maxLeft) left = maxLeft;
          if(left < window.scrollX + 16) left = window.scrollX + 16;
          bubble.style.left = left + 'px';
          bubble.style.top = top + 'px';
          bubble.setAttribute('aria-hidden', 'false');
        });
      }
      function hideBubble(){
        if(!bubble) return;
        bubble.style.display = 'none';
        bubble.setAttribute('aria-hidden', 'true');
      }
      function handleCharClick(ev){
        const el = ev.currentTarget;
        const lineIndex = Number(el.dataset.line);
        const charIndex = Number(el.dataset.index);
        const line = getLine(lineIndex);
        const cell = (line.chars || [])[charIndex] || { c: el.textContent || '' };
        const phrase = getPhrase(lineIndex, charIndex);
        clearActive();
        let payload;
        if(phrase){
          highlightRange(lineIndex, phrase.s, phrase.e);
          payload = {
            scope: '词组',
            title: getPhraseText(lineIndex, phrase.s, phrase.e),
            pinyin: phrase.p || cell.p || '',
            gloss: phrase.g || cell.g || ''
          };
        }else{
          el.classList.add('active');
          payload = {
            scope: '单字',
            title: cell.c || el.textContent || '',
            pinyin: cell.p || '',
            gloss: cell.g || ''
          };
        }
        updateInfo(payload);
        showBubble(el, payload);
      }
      function enhancePanel(){
        if(!panel) return;
        if(panel.children.length){
          panel.querySelectorAll('.char').forEach(span => {
            if(span.classList.contains('punct')) return;
            span.addEventListener('click', handleCharClick);
          });
          return;
        }
        data.lines.forEach(line => {
          const lineEl = document.createElement('div');
          lineEl.className = 'line';
          Array.from(line.text || '').forEach((ch, idx) => {
            const span = document.createElement('span');
            span.className = 'char';
            span.textContent = ch === ' ' ? '\u00a0' : ch;
            span.dataset.line = line.index;
            span.dataset.index = idx;
            if(punctuationRe.test(ch)){
              span.classList.add('punct');
            }else{
              span.addEventListener('click', handleCharClick);
            }
            lineEl.appendChild(span);
          });
          panel.appendChild(lineEl);
        });
      }

      enhancePanel();
      resetInfo();
      document.addEventListener('click', ev => {
        if(ev.target.closest('.char')) return;
        if(ev.target.closest('.bubble')) return;
        clearActive();
        resetInfo();
        hideBubble();
      });
      document.addEventListener('keydown', ev => {
        if(ev.key === 'Escape'){
          clearActive();
          resetInfo();
          hideBubble();
        }
      });
    })();
  ${SCRIPT_PLACEHOLDER}
</body>
</html>`;
      html = html.split(SCRIPT_PLACEHOLDER).join(SCRIPT_CLOSING);
      return html;
    }

    function createDownloadUrl(name, content){
      if(state.downloadUrls.has(name)){
        URL.revokeObjectURL(state.downloadUrls.get(name));
      }
      const blob = new Blob([content], { type: 'text/html;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      state.downloadUrls.set(name, url);
      return url;
    }

    function upsertResultCard(entry){
      const container = $('#results');
      let card = container.querySelector(`[data-file="${entry.file}"]`);
      if(!card){
        card = document.createElement('article');
        card.className = 'result-card';
        card.dataset.file = entry.file;
        container.appendChild(card);
      }
      const previewLines = entry.translation.lines.slice(0, 2).map(line => {
        const glossPreview = line.chars.filter(cell => cell.g).slice(0, 6).map(cell => `${cell.c}（${cell.g}）`).join('、');
        return `<div class="line-pair"><p>${escapeHtml(line.text)}</p><p>${escapeHtml(glossPreview || '暂无释义')}</p></div>`;
      }).join('');
      card.innerHTML = `
        <header>
          <h3>${escapeHtml(entry.title)}</h3>
          <div class="btn-row" style="gap:8px">
            <span class="chip">${escapeHtml(entry.file.replace(/\.txt$/i, '.html'))}</span>
            <span class="status">已生成逐字注释页面，可下载</span>
          </div>
        </header>
        <div class="downloads">
          <a href="${entry.url}" download="${escapeHtml(entry.downloadName)}">下载注释 HTML</a>
          <button data-action="preview">复制完整 HTML</button>
        </div>
        <details>
          <summary>注释预览（前两行）</summary>
          ${previewLines || '<p class="status">暂无预览</p>'}
        </details>
      `;
      const previewBtn = card.querySelector('button[data-action="preview"]');
      previewBtn.addEventListener('click', () => {
        if(navigator.clipboard && typeof navigator.clipboard.writeText === 'function'){
          navigator.clipboard.writeText(entry.html).then(() => {
            previewBtn.textContent = '已复制到剪贴板';
            setTimeout(() => previewBtn.textContent = '复制完整 HTML', 2600);
          }).catch(() => {
            previewBtn.textContent = '复制失败，请手动选择';
            setTimeout(() => previewBtn.textContent = '复制完整 HTML', 2600);
          });
        }else{
          previewBtn.textContent = '此浏览器不支持自动复制';
          setTimeout(() => previewBtn.textContent = '复制完整 HTML', 2600);
        }
      });
    }

    function rebuildNavigation(){
      if(!state.generated.length){
        $('#navSection').hidden = true;
        if(state.navUrl){
          URL.revokeObjectURL(state.navUrl);
          state.navUrl = null;
        }
        return;
      }
      const linksHtml = state.generated.map(entry => `      <li><a href="${escapeHtml(entry.downloadName)}">${escapeHtml(entry.title)}</a></li>`).join('\n');
      const indexHtml = `<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>聊斋逐字注释导航</title>
  <style>
    body{margin:0;font-family:"Noto Sans SC","PingFang SC","Microsoft YaHei",sans-serif;background:#0b111a;color:#e8efff;padding:28px;line-height:1.8}
    h1{margin-top:0;font-size:28px}
    ul{list-style:decimal;padding-left:22px}
    a{color:#4da3ff;text-decoration:none}
    a:hover{text-decoration:underline}
    footer{margin-top:32px;font-size:12px;color:#8da0bf}
  </style>
</head>
<body>
  <h1>聊斋逐字注释导航</h1>
  <p>本导航列出本次生成的所有 DeepSeek 逐字注释页面，下载后放在同一目录即可直接打开。</p>
  <ul>
${linksHtml}
  </ul>
  <footer>生成时间：${escapeHtml(new Date().toLocaleString())}</footer>
</body>
</html>`;
      if(state.navUrl){
        URL.revokeObjectURL(state.navUrl);
      }
      const blob = new Blob([indexHtml], { type: 'text/html;charset=utf-8' });
      state.navUrl = URL.createObjectURL(blob);
      $('#navDownload').href = state.navUrl;
      $('#navPreview').value = indexHtml;
      $('#navSection').hidden = false;
    }

    async function generateSelected(){
      let selected;
      try{
        selected = getSelectedIndexes();
        if(!selected.length){
          $('#globalStatus').textContent = '请至少选择一个篇目';
          setTimeout(() => $('#globalStatus').textContent = '', 2400);
          return;
        }
        const cfg = getApiConfig();
        $('#globalStatus').textContent = '正在生成逐字注释，请稍候…';
        $('#generateSelected').disabled = true;
        for(const index of selected){
          const meta = state.manifest[index];
          const statusEl = getStatusEl(index);
          try{
            if(statusEl){
              statusEl.textContent = '读取原文…';
              statusEl.className = 'file-status';
            }
            const res = await fetch('book/' + meta.file);
            if(!res.ok) throw new Error('无法读取原文');
            const text = await res.text();
            const parsed = parseContent(text);
            if(parsed.originalLines.length === 0){
              throw new Error('未找到可注释的原文段落');
            }
            if(statusEl){
              statusEl.textContent = '调用 DeepSeek 中…';
            }
            const payload = await translateWithDeepseek(cfg, meta, parsed);
            const translation = normaliseTranslation(parsed, payload);
            const html = buildPageHtml(meta, parsed, translation);
            const downloadName = meta.file.replace(/\.txt$/i, '.html');
            const url = createDownloadUrl(downloadName, html);
            const entry = {
              file: meta.file,
              title: translation.title || meta.title || meta.file,
              html,
              url,
              downloadName,
              translation
            };
            const existingIndex = state.generated.findIndex(it => it.file === meta.file);
            if(existingIndex >= 0){
              state.generated[existingIndex] = entry;
            }else{
              state.generated.push(entry);
            }
            upsertResultCard(entry);
            if(statusEl){
              statusEl.textContent = '生成完成';
              statusEl.classList.add('success');
            }
          }catch(err){
            console.error(err);
            if(statusEl){
              statusEl.textContent = err.message;
              statusEl.classList.add('error');
            }
          }
        }
        $('#globalStatus').textContent = '处理结束';
        setTimeout(() => $('#globalStatus').textContent = '', 2600);
        rebuildNavigation();
      }catch(err){
        console.error(err);
        $('#globalStatus').textContent = err.message || '生成失败';
      }finally{
        $('#generateSelected').disabled = false;
      }
    }

    $('#generateSelected').addEventListener('click', generateSelected);

    async function init(){
      loadApiConfig();
      try{
        const manifest = await fetchManifest();
        state.manifest = manifest;
        renderManifest(manifest);
      }catch(err){
        $('#globalStatus').textContent = '加载篇目失败：' + err.message;
      }
    }

    init();
  </script>
</body>
</html>
