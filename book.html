<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>聊斋志异 · 原文白话点评合集</title>
  <style>
    :root{--bg:#080c12;--card:#111824;--text:#e9f0ff;--muted:#8899b5;--accent:#4da3ff;--border:#1c2535;--chip:#1a2537;--yellow:#ffd166;}
    *{box-sizing:border-box}
    body{margin:0;font-family:"Noto Sans SC","PingFang SC","Microsoft YaHei",system-ui,-apple-system,Segoe UI,sans-serif;background:linear-gradient(180deg,#070b11,#0c131d);color:var(--text);}
    header{padding:24px 20px 12px;max-width:1100px;margin:0 auto;display:flex;flex-direction:column;gap:12px}
    header h1{margin:0;font-size:26px;font-weight:700}
    header p{margin:0;color:var(--muted);font-size:14px}
    .config-card{max-width:1100px;margin:0 auto 16px;background:var(--card);border:1px solid var(--border);border-radius:18px;padding:16px 20px;display:grid;gap:12px}
    .config-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:12px}
    label{display:flex;flex-direction:column;gap:6px;font-size:13px;color:var(--muted)}
    input{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0a111c;color:var(--text);font-size:14px}
    button{padding:10px 16px;border-radius:12px;border:1px solid var(--border);background:var(--chip);color:var(--text);cursor:pointer;font-size:13px}
    button.primary{background:var(--accent);color:#02182d;border:1px solid rgba(255,255,255,0.08)}
    button:disabled{opacity:.5;cursor:not-allowed}
    .stories{max-width:1100px;margin:0 auto 80px;display:flex;flex-direction:column;gap:18px;padding:0 20px 40px}
    article{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:20px;display:flex;flex-direction:column;gap:16px}
    article header{padding:0;margin:0}
    article header h2{margin:0;font-size:20px;font-weight:700}
    article header .meta{color:var(--muted);font-size:13px}
    .story-grid{display:grid;gap:18px;grid-template-columns:minmax(0,1fr)}
    @media(min-width:960px){.story-grid{grid-template-columns:1.1fr 0.9fr}}
    .orig-card,.info-card{background:#0b121d;border:1px solid var(--border);border-radius:16px;padding:16px;display:flex;flex-direction:column;gap:12px}
    .orig-card h3,.info-card h3{margin:0;font-size:17px}
    .text-panel{max-height:65vh;overflow:auto;border-radius:14px;border:1px solid var(--border);background:#070d15;padding:12px}
    .line{margin:6px 0;line-height:2.1}
    .char{display:inline-block;padding:2px 6px;margin:0 1px;border-radius:8px;cursor:pointer;transition:background .15s ease}
    .char:hover{background:rgba(77,163,255,.12)}
    .char[data-has="1"]{background:rgba(77,163,255,.1);border-bottom:1px dashed rgba(77,163,255,.45)}
    .punct{cursor:default;opacity:.55}
    .chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted)}
    .section{display:flex;flex-direction:column;gap:8px}
    .section h4{margin:0;font-size:15px;color:var(--accent)}
    .section p{margin:0;line-height:1.8;white-space:pre-wrap;color:var(--text)}
    .status{font-size:12px;color:var(--muted)}
    .control-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    #bubble{position:fixed;display:none;max-width:320px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px;box-shadow:0 12px 36px rgba(0,0,0,.45);z-index:9999;pointer-events:none}
    #bubble .b-hd{display:flex;align-items:baseline;gap:8px;margin-bottom:6px}
    #bubble .b-char{font-size:18px;font-weight:700}
    #bubble .b-pinyin{font-size:14px;color:var(--yellow)}
    #bubble .b-gloss{font-size:13px;color:var(--text)}
    #bubble .b-empty{color:var(--muted);font-style:italic}
  </style>
</head>
<body>
  <header>
    <h1>《聊斋志异》原文·白话·点评合集</h1>
    <p>自动读取 <code>book</code> 目录下的 txt 文件，展示原文、白话译文与点评，并可调用 DeepSeek API 对文言逐字/词组释义。</p>
  </header>

  <section class="config-card" aria-label="API 配置">
    <div class="config-grid">
      <label>API 地址
        <input id="apiUrl" placeholder="https://api.deepseek.com/v1/chat/completions" />
      </label>
      <label>API Key
        <input id="apiKey" type="password" placeholder="Bearer 密钥" />
      </label>
      <label>模型
        <input id="apiModel" placeholder="deepseek-chat" />
      </label>
    </div>
    <div class="control-row">
      <button id="saveApi" class="primary">保存配置</button>
      <button id="loadAll">批量生成全部释义</button>
      <span class="status" id="globalStatus"></span>
    </div>
  </section>

  <main class="stories" id="stories" aria-live="polite"></main>
  <div id="bubble" role="tooltip" aria-hidden="true"></div>

  <script type="module">
    const $ = (sel, ctx=document) => ctx.querySelector(sel);
    const isPunct = ch => /[\u3000\s，。、“”《》？！；：（）——…,.!?;:()\-\[\]{}]/.test(ch);
    const API_STORE_KEY = 'liaozhai_ctx_api';
    const NOTE_PREFIX = 'liaozhai_book_auto_';

    const globalState = { pages: [], current: null };

    function escapeHtml(str=''){
      return str.replace(/[&<>"']/g,ch=>({
        '&':'&amp;',
        '<':'&lt;',
        '>':'&gt;',
        '"':'&quot;',
        "'":'&#39;'
      })[ch]||ch);
    }

    function loadApiConfig(){
      try{
        const raw = localStorage.getItem(API_STORE_KEY) || localStorage.getItem(API_STORE_KEY+'_backup') || '{}';
        const cfg = JSON.parse(raw);
        $('#apiUrl').value = cfg.url || '';
        $('#apiKey').value = cfg.key || '';
        $('#apiModel').value = cfg.model || '';
        return cfg;
      }catch(err){
        console.warn('load api config failed', err);
        return {};
      }
    }

    function saveApiConfig(){
      const cfg = {
        url: $('#apiUrl').value.trim(),
        key: $('#apiKey').value.trim(),
        model: $('#apiModel').value.trim()
      };
      localStorage.setItem(API_STORE_KEY, JSON.stringify(cfg));
      localStorage.setItem(API_STORE_KEY+'_backup', JSON.stringify(cfg));
      $('#globalStatus').textContent = 'API 配置已保存（仅存于本机）';
      setTimeout(()=>$('#globalStatus').textContent='', 3200);
      return cfg;
    }

    $('#saveApi').addEventListener('click', saveApiConfig);

    function getStoreKey(file){
      return NOTE_PREFIX + file;
    }

    function loadPageNotes(file){
      try{
        const raw = localStorage.getItem(getStoreKey(file));
        if(!raw) return null;
        const obj = JSON.parse(raw);
        if(!obj || !Array.isArray(obj.lines)) return null;
        return obj;
      }catch(err){
        console.warn('load notes failed', err);
        return null;
      }
    }

    function savePageNotes(file, notes){
      localStorage.setItem(getStoreKey(file), JSON.stringify(notes));
    }

    async function fetchManifest(){
      const res = await fetch('book/manifest.json');
      if(!res.ok) throw new Error('无法读取 book/manifest.json');
      return res.json();
    }

    function parseContent(text){
      const title = (text.match(/标题：\s*(.+)/) || [])[1]?.trim() || '';
      const rawOriginal = splitSection(text, '【原文】', '【白话文翻译】');
      const rawVernacular = splitSection(text, '【白话文翻译】', '【点评】');
      const rawComment = splitSection(text, '【点评】');
      const lines = rawOriginal.split(/\r?\n+/).map(s=>s.trim()).filter(Boolean);
      return {
        title,
        originalText: rawOriginal.trim(),
        originalLines: lines,
        vernacular: rawVernacular.trim(),
        comment: rawComment.trim()
      };
    }

    function splitSection(text, start, end){
      const idx = start ? text.indexOf(start) : 0;
      if(idx === -1) return '';
      const begin = idx + (start ? start.length : 0);
      if(!end) return text.slice(begin);
      const next = text.indexOf(end, begin);
      return next === -1 ? text.slice(begin) : text.slice(begin, next);
    }

    function createStoryCard(page, index){
      const article = document.createElement('article');
      article.setAttribute('data-page-index', index);
      const vernacularHtml = escapeHtml(page.vernacular).replace(/\n/g,'<br />');
      const commentHtml = escapeHtml(page.comment).replace(/\n/g,'<br />');
      article.innerHTML = `
        <header>
          <h2>${page.title || page.meta?.title || page.file}</h2>
          <div class="meta">
            <span class="chip">原文 ${page.originalLines.length} 行</span>
            <span class="chip">逐字释义可点击查看</span>
          </div>
        </header>
        <div class="story-grid">
          <section class="orig-card">
            <h3>原文逐字释义</h3>
            <div class="control-row">
              <button class="primary" data-action="annotate">生成 DeepSeek 释义</button>
              <button data-action="clear">清除释义缓存</button>
              <span class="status" data-role="status"></span>
            </div>
            <div class="text-panel" data-role="text"></div>
          </section>
          <section class="info-card">
            <div class="section">
              <h4>白话译文</h4>
              <p>${vernacularHtml}</p>
            </div>
            <div class="section">
              <h4>点评</h4>
              <p>${commentHtml}</p>
            </div>
          </section>
        </div>`;

      const textPanel = article.querySelector('[data-role="text"]');
      renderOriginalLines(textPanel, index, page.originalLines);
      const notes = loadPageNotes(page.file);
      if(notes){
        page.notes = notes;
        applyNotesToPage(index);
      }
      article.addEventListener('click', evt=>handleArticleClick(evt, index));
      return article;
    }

    function renderOriginalLines(container, pageIndex, lines){
      container.innerHTML = '';
      const page = globalState.pages[pageIndex];
      page.elements = [];
      lines.forEach((line, li)=>{
        const div = document.createElement('div');
        div.className = 'line';
        const chars = Array.from(line);
        page.elements[li] = [];
        chars.forEach((ch, ci)=>{
          const span = document.createElement('span');
          span.textContent = ch;
          span.dataset.page = pageIndex;
          span.dataset.line = li;
          span.dataset.char = ci;
          span.className = 'char' + (isPunct(ch) ? ' punct' : '');
          if(!isPunct(ch)){
            span.addEventListener('click', onCharClick);
          }
          div.appendChild(span);
          page.elements[li][ci] = span;
        });
        container.appendChild(div);
      });
    }

    function handleArticleClick(evt, pageIndex){
      const action = evt.target.closest('button[data-action]');
      if(!action) return;
      evt.preventDefault();
      const role = action.dataset.action;
      if(role === 'annotate'){
        annotatePage(pageIndex, action);
      }else if(role === 'clear'){
        clearPageNotes(pageIndex);
      }
    }

    function clearPageNotes(pageIndex){
      const page = globalState.pages[pageIndex];
      page.notes = {lines:[], phrases:{}};
      localStorage.removeItem(getStoreKey(page.file));
      applyNotesToPage(pageIndex);
      const status = getPageStatusEl(pageIndex);
      if(status){
        status.textContent = '已清除释义缓存';
        setTimeout(()=>status.textContent='', 2200);
      }
    }

    function getPageStatusEl(pageIndex){
      const article = document.querySelector(`article[data-page-index="${pageIndex}"]`);
      return article ? article.querySelector('[data-role="status"]') : null;
    }

    function applyNotesToPage(pageIndex){
      const page = globalState.pages[pageIndex];
      const notes = page.notes || {lines:[], phrases:{}};
      const spans = page.elements || [];
      spans.forEach((row, li)=>{
        row.forEach((span, ci)=>{
          if(!span || span.classList.contains('punct')) return;
          const cell = (notes.lines?.[li] || [])[ci];
          span.dataset.pinyin = cell?.p || '';
          span.dataset.gloss = cell?.g || '';
          span.dataset.has = (cell && (cell.p || cell.g)) ? '1' : '';
        });
      });
      highlightPhrases(pageIndex);
    }

    function highlightPhrases(pageIndex){
      const page = globalState.pages[pageIndex];
      const spans = page.elements || [];
      spans.forEach(row=>row.forEach(span=>{
        if(span && !span.classList.contains('punct')) span.classList.remove('phrase');
      }));
      const phrases = page.notes?.phrases || {};
      Object.entries(phrases).forEach(([line, arr])=>{
        const li = Number(line);
        if(!Array.isArray(arr)) return;
        arr.forEach(ph=>{
          for(let i=ph.s;i<=ph.e;i++){
            const span = spans?.[li]?.[i];
            if(span){
              span.classList.add('phrase');
            }
          }
        });
      });
    }

    function onCharClick(evt){
      const span = evt.currentTarget;
      const pageIndex = Number(span.dataset.page);
      const lineIndex = Number(span.dataset.line);
      const charIndex = Number(span.dataset.char);
      globalState.current = {pageIndex, lineIndex, charIndex, span};
      showBubble(pageIndex, lineIndex, charIndex, span);
    }

    function hideBubble(){
      const bubble = $('#bubble');
      bubble.style.display = 'none';
      bubble.setAttribute('aria-hidden','true');
    }

    document.addEventListener('click', evt=>{
      if(evt.target.closest('.char')) return;
      if(evt.target.closest('#bubble')) return;
      hideBubble();
    });

    function hitPhrase(pageIndex, lineIndex, charIndex){
      const phrases = globalState.pages[pageIndex].notes?.phrases?.[lineIndex] || [];
      return phrases.find(ph=>charIndex>=ph.s && charIndex<=ph.e) || null;
    }

    function getSpanText(pageIndex, lineIndex, start, end){
      const line = globalState.pages[pageIndex].originalLines[lineIndex] || '';
      return Array.from(line).slice(start, end+1).join('');
    }

    function showBubble(pageIndex, lineIndex, charIndex, target){
      const page = globalState.pages[pageIndex];
      const notes = page.notes || {lines:[], phrases:{}};
      const ph = hitPhrase(pageIndex, lineIndex, charIndex);
      const cell = (notes.lines?.[lineIndex] || [])[charIndex] || {};
      let title = target.textContent || cell.c || '';
      let pinyin = cell.p || '';
      let gloss = cell.g || '';
      if(ph){
        title = getSpanText(pageIndex, lineIndex, ph.s, ph.e);
        pinyin = ph.p || pinyin;
        gloss = ph.g || gloss;
      }
      const bubble = $('#bubble');
      bubble.innerHTML = `<div class="b-hd"><span class="b-char">${title}</span><span class="b-pinyin">${pinyin || '—'}</span></div><div class="b-gloss">${gloss || '<span class="b-empty">暂无释义，可点击“生成 DeepSeek 释义”</span>'}</div>`;
      bubble.style.display = 'block';
      bubble.setAttribute('aria-hidden','false');
      requestAnimationFrame(()=>{
        const rect = target.getBoundingClientRect();
        const left = rect.left + window.scrollX;
        const top = rect.bottom + window.scrollY + 8;
        bubble.style.left = Math.min(left, window.scrollX + window.innerWidth - bubble.offsetWidth - 12) + 'px';
        bubble.style.top = top + 'px';
      });
    }

    function getApiConfig(){
      const url = $('#apiUrl').value.trim();
      const key = $('#apiKey').value.trim();
      const model = $('#apiModel').value.trim() || 'deepseek-chat';
      if(!url || !key){
        throw new Error('请先填写 API 地址与 Key');
      }
      return {url, key, model};
    }

    async function annotatePage(pageIndex, triggerBtn){
      const page = globalState.pages[pageIndex];
      const status = getPageStatusEl(pageIndex);
      try{
        const cfg = getApiConfig();
        if(status){
          status.textContent = '正在调用 DeepSeek …';
        }
        triggerBtn.disabled = true;
        const payload = await requestDeepseek(cfg, page);
        page.notes = mergePayloadToNotes(page, payload);
        savePageNotes(page.file, page.notes);
        applyNotesToPage(pageIndex);
        if(status){
          status.textContent = '释义生成完成';
          setTimeout(()=>status.textContent='', 2600);
        }
      }catch(err){
        console.error(err);
        if(status){
          status.textContent = '生成失败：' + err.message;
        }
      }finally{
        triggerBtn.disabled = false;
      }
    }

    async function requestDeepseek(cfg, page){
      const req = {
        lines: page.originalLines.map((text, index)=>({
          index,
          text,
          charList: Array.from(text).map((ch,i)=>({i,ch})),
          knownPhrases: (page.notes?.phrases?.[index] || []).map(ph=>({s:ph.s,e:ph.e,g:ph.g||'',p:ph.p||''}))
        }))
      };
      const body = {
        model: cfg.model,
        messages: [
          {
            role:'system',
            content:'你是文言文标注助手。对整段文本（多行），请对每一行：先识别应优先的词组并给出释义，再补充必要的单字释义。不要生成整段白话。\\n严格只返回 JSON：{"lines":[{"index":行号,"chars":[{"i":索引,"g":"释义","p":"拼音(可选)","ch":"原字(可选)"}],"phrases":[{"s":起,"e":止,"g":"释义","p":"拼音(可选)"}]}]}.\\n要求：每一行的索引必须来源于请求提供的 charList，且不得越界或改写字符。'
          },
          { role:'user', content: JSON.stringify(req) }
        ],
        temperature: 0.2,
        response_format: {type:'json_object'}
      };
      const res = await fetch(cfg.url, {
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'Authorization':'Bearer ' + cfg.key
        },
        body: JSON.stringify(body)
      });
      if(!res.ok){
        const txt = await res.text();
        throw new Error('HTTP ' + res.status + ': ' + txt.slice(0,180));
      }
      const data = await res.json();
      let payload = data;
      if(data?.choices?.[0]?.message?.content){
        try{
          payload = JSON.parse(data.choices[0].message.content);
        }catch(err){
          console.warn('parse response failed', err);
        }
      }
      return payload;
    }

    function mergePayloadToNotes(page, payload){
      const notes = page.notes || {lines:[], phrases:{}};
      if(!payload?.lines) return notes;
      payload.lines.forEach(lineObj=>{
        const li = Number(lineObj.index);
        if(Number.isNaN(li)) return;
        const text = page.originalLines[li] || '';
        const len = text.length;
        if(!notes.lines) notes.lines = [];
        notes.lines[li] = notes.lines[li] || [];
        if(Array.isArray(lineObj.chars)){
          lineObj.chars.forEach(item=>{
            const idx = Number(item.i);
            if(!Number.isInteger(idx) || idx<0 || idx>=len) return;
            const chAt = Array.from(text)[idx];
            if(item.ch && item.ch !== chAt) return;
            const prev = notes.lines[li][idx] || {c: chAt};
            notes.lines[li][idx] = {
              c: prev.c || chAt,
              p: item.p || prev.p || '',
              g: item.g || prev.g || ''
            };
          });
        }
        if(Array.isArray(lineObj.phrases)){
          notes.phrases = notes.phrases || {};
          const list = notes.phrases[li] = notes.phrases[li] || [];
          lineObj.phrases.forEach(ph=>{
            let s = Number(ph.s);
            let e = Number(ph.e);
            if(!Number.isInteger(s) || !Number.isInteger(e)) return;
            if(s>e) [s,e] = [e,s];
            if(s<0 || e>=len) return;
            const record = {s,e,p:ph.p||'',g:ph.g||''};
            const idx = list.findIndex(x=>x.s===s && x.e===e);
            if(idx>=0) list[idx]=record; else list.push(record);
          });
        }
      });
      return notes;
    }

    async function init(){
      loadApiConfig();
      try{
        const manifest = await fetchManifest();
        const storiesEl = $('#stories');
        for(let i=0;i<manifest.length;i++){
          const meta = manifest[i];
          const res = await fetch('book/' + meta.file);
          if(!res.ok) throw new Error('无法读取 ' + meta.file);
          const text = await res.text();
          const parsed = parseContent(text);
          const page = { file: meta.file, meta, ...parsed };
          globalState.pages.push(page);
          const article = createStoryCard(page, i);
          storiesEl.appendChild(article);
        }
      }catch(err){
        $('#globalStatus').textContent = '加载失败：' + err.message;
      }
    }

    async function batchAnnotate(){
      const cfg = getApiConfig();
      $('#globalStatus').textContent = '正在批量生成释义…';
      for(let i=0;i<globalState.pages.length;i++){
        const article = document.querySelector(`article[data-page-index="${i}"]`);
        const status = article?.querySelector('[data-role="status"]');
        if(status) status.textContent = '调用中…';
        try{
          const payload = await requestDeepseek(cfg, globalState.pages[i]);
          globalState.pages[i].notes = mergePayloadToNotes(globalState.pages[i], payload);
          savePageNotes(globalState.pages[i].file, globalState.pages[i].notes);
          applyNotesToPage(i);
          if(status) status.textContent = '完成';
        }catch(err){
          console.error(err);
          if(status) status.textContent = '失败：' + err.message;
        }
      }
      $('#globalStatus').textContent = '批量处理结束';
      setTimeout(()=>$('#globalStatus').textContent='', 3000);
    }

    $('#loadAll').addEventListener('click', ()=>{
      try{
        batchAnnotate();
      }catch(err){
        $('#globalStatus').textContent = err.message;
      }
    });

    window.addEventListener('scroll', ()=>{
      if(globalState.current){
        const {pageIndex, lineIndex, charIndex, span} = globalState.current;
        if(span && document.body.contains(span)){
          showBubble(pageIndex, lineIndex, charIndex, span);
        }
      }
    }, {passive:true});

    init();
  </script>
</body>
</html>
