<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å­—é˜µ Â· åŒæ ¸æ–‡è¨€æœº (åŒAPIç‰ˆ)</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;500;700&family=Noto+Sans+SC:wght@300;400;500&display=swap" rel="stylesheet" />

  <style>
    :root {
      --bg-color: #f6f3e8;
      --text-main: #2b2b2b;
      --text-light: #666;
      --accent-red: #c0392b;
      --accent-green: #5d7a6f;
      --border-color: #eee;
      --card: rgba(255, 255, 255, 0.85);
    }

    @font-face { font-family: "GlyphOracle"; src: url("ç”²éª¨æ–‡.ttf") format("truetype"); font-display: swap; }
    @font-face { font-family: "GlyphBronze"; src: url("é‡‘æ–‡å¤§ç¯†ä½“.ttf") format("truetype"); font-display: swap; }
    @font-face { font-family: "GlyphSeal"; src: url("æ–¹æ­£å°ç¯†ä½“.ttf") format("truetype"); font-display: swap; }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      background-color: var(--bg-color);
      color: var(--text-main);
      font-family: "Noto Sans SC", sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      padding: 18px 24px;
      display: flex; justify-content: space-between; align-items: center;
      background: rgba(246, 243, 232, 0.98);
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      position: sticky; top: 0; z-index: 20;
    }

    .book-title { font-family: "Noto Serif SC", serif; font-size: 20px; font-weight: 700; }
    .header-actions { display: flex; gap: 10px; }

    button {
      border: none; border-radius: 999px; padding: 8px 16px; font-size: 14px;
      cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn-secondary { background: #fff; border: 1px solid rgba(0, 0, 0, 0.06); }
    .btn-primary { background: var(--accent-green); color: #fff; box-shadow: 0 8px 20px rgba(93, 122, 111, 0.25); }
    button:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; }

    .control-panel {
      padding: 20px 24px 10px;
      display: grid; grid-template-columns: 1fr 260px; gap: 20px;
    }

    .control-panel textarea {
      width: 100%; min-height: 140px; border: 1px solid var(--border-color);
      border-radius: 18px; padding: 18px; font-size: 16px; line-height: 1.8;
      background: #fff; font-family: "Noto Serif SC", serif; resize: none;
    }

    .control-meta {
      background: var(--card); border: 1px solid var(--border-color);
      border-radius: 18px; padding: 18px; display: flex; flex-direction: column;
      gap: 14px; max-height: calc(100vh - 150px); overflow-y: auto;
    }

    .batch-panel {
      margin-top: 12px; border: 1px dashed var(--border-color); border-radius: 12px;
      padding: 12px; background: rgba(255, 255, 255, 0.6);
    }
    .batch-files {
      margin-top: 10px; max-height: 120px; overflow-y: auto;
      border: 1px solid #ddd; border-radius: 10px; padding: 8px;
      background: #fff; font-size: 13px;
    }
    .batch-item { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; border-bottom: 1px solid #eee; }
    .batch-item:last-child { border-bottom: none; }
    .batch-item button { border: none; background: none; color: #c0392b; cursor: pointer; }

    .meta-title { font-weight: 600; font-size: 14px; color: var(--text-light); }
    .status-pill { background: rgba(93, 122, 111, 0.1); color: var(--accent-green); padding: 6px 12px; border-radius: 999px; font-size: 12px; }

    .reader-wrapper { flex: 1; padding: 0 24px 24px; display: grid; grid-template-columns: 2fr 1fr; gap: 24px; }
    .reader-container { padding: 24px; border-radius: 24px; background: #fff; line-height: 2.2; font-size: 26px; font-family: "Noto Serif SC", serif; min-height: 320px; }
    .translation-panel { background: #fff; border-radius: 24px; padding: 24px; border: 1px solid var(--border-color); min-height: 320px; }
    .translation-panel h3 { font-size: 16px; color: var(--text-light); margin-bottom: 10px; }
    .translation-panel p { font-family: "Noto Sans SC", sans-serif; line-height: 1.8; margin-bottom: 10px; font-size: 15px; color: var(--text-main); }

    .char { display: inline-block; padding: 2px 3px; border-radius: 6px; cursor: pointer; transition: all 0.2s; position: relative; }
    .char.active { background-color: var(--accent-red); color: #fff; transform: scale(1.08); z-index: 2; }
    .punct { display: inline-block; margin-right: 4px; color: #999; font-family: "Noto Serif SC", serif; }

    .overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.4); opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 90; }
    .overlay.show { opacity: 1; pointer-events: auto; }
    .bottom-sheet { position: fixed; left: 0; right: 0; bottom: 0; background: #fff; border-radius: 20px 20px 0 0; transform: translateY(105%); transition: transform 0.35s; z-index: 100; height: 70vh; display: flex; flex-direction: column; }
    .bottom-sheet.show { transform: translateY(0); }
    .sheet-handle { width: 42px; height: 5px; background: #ddd; border-radius: 999px; margin: 10px auto; }
    .sheet-header { padding: 8px 24px 16px; border-bottom: 1px solid #eee; display: flex; align-items: flex-end; gap: 12px; }
    .big-char { font-size: 48px; font-family: "Noto Serif SC", serif; }
    .pinyin { font-size: 18px; color: var(--accent-red); font-weight: 600; }
    .radical { font-size: 13px; color: #888; background: #f5f5f5; padding: 2px 8px; border-radius: 6px; }

    .tabs { display: flex; border-bottom: 1px solid #eee; }
    .tab { flex: 1; text-align: center; padding: 14px 0; color: #888; cursor: pointer; }
    .tab.active { color: var(--accent-green); font-weight: 600; border-bottom: 3px solid var(--accent-green); }
    .sheet-body { flex: 1; overflow-y: auto; padding: 20px 24px; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .context-meaning { margin-bottom: 12px; }
    .context-term { font-size: 20px; font-weight: 600; }
    .context-label { font-size: 12px; border: 1px solid #ddd; padding: 2px 6px; border-radius: 4px; margin-right: 6px; }
    .context-def { margin-top: 6px; color: #444; }
    .translation-box { background: #f9f9f9; padding: 14px; border-radius: 10px; margin-top: 15px; font-size: 15px; }
    .dict-list-item { margin-bottom: 6px; }

    /* å­—æºå­—ä½“å›é€€ */
    .font-oracle { font-family: "GlyphOracle", "KaiTi", "æ¥·ä½“", serif; }
    .font-bronze { font-family: "GlyphBronze", "KaiTi", "æ¥·ä½“", serif; }
    .font-seal { font-family: "GlyphSeal", "FZShuTi", "KaiTi", "æ¥·ä½“", serif; }

    .settings-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 120; }
    .settings-modal.active { display: flex; }
    .modal-card { background: #fff; border-radius: 20px; padding: 28px; width: min(480px, 92vw); max-height: 90vh; overflow-y: auto;}
    .log-panel { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; background: #f0f0f0; border-radius: 10px; padding: 10px; max-height: 140px; overflow-y: auto; }
    input { border: 1px solid #ddd; border-radius: 10px; outline: none; }
    input:focus { border-color: rgba(93, 122, 111, 0.9); box-shadow: 0 0 0 3px rgba(93, 122, 111, 0.12); }
    
    .setting-group { margin-bottom: 20px; border: 1px solid #eee; padding: 15px; border-radius: 12px; background: #fcfcfc; }
    .setting-group h4 { font-size: 14px; color: var(--accent-green); margin-bottom: 10px; border-bottom: 1px dashed #ddd; padding-bottom: 6px;}
  </style>
</head>

<body>
  <div class="header">
    <div class="book-title">å­—é˜µ Â· åŒæ ¸æ–‡è¨€æœº</div>
    <div class="header-actions">
      <button class="btn-secondary" id="btnDownload" type="button">å¯¼å‡ºç»“æœ</button>
      <button class="btn-secondary" id="btnSettings" type="button">API è®¾ç½®</button>
      <button class="btn-primary" id="btnTranslate" type="button">å•ç¯‡å¤„ç†</button>
    </div>
  </div>

  <section class="control-panel">
    <div>
      <textarea id="textInput" placeholder="åœ¨æ­¤è¾“å…¥æˆ–ç²˜è´´æ–‡è¨€æ–‡..."></textarea>

      <div class="batch-panel">
        <div class="meta-title">æ‰¹é‡å¯¼å…¥ï¼ˆæ”¯æŒ .txtï¼‰</div>
        <div style="display:flex; gap:10px; margin-top:8px;">
          <button class="btn-secondary" id="btnBatchImport" type="button">å¯¼å…¥æ–‡ä»¶</button>
          <button class="btn-secondary" id="btnBatchStart" type="button">å¼€å§‹æ‰¹é‡</button>
          <span id="batchInfo" style="font-size:12px; color:#666; align-self:center;">æœªå¯¼å…¥ä»»åŠ¡</span>
        </div>
        <input type="file" id="batchFile" multiple accept=".txt,text/plain" style="display:none" />
        <div id="batchFiles" class="batch-files" style="display:none"></div>
      </div>
    </div>

    <div class="control-meta">
      <div>
        <div class="meta-title">ç³»ç»ŸçŠ¶æ€</div>
        <div class="status-pill" id="statusPill">å¾…å‘½</div>
      </div>

      <div>
        <div class="meta-title">è¯åº“ç¼“å­˜</div>
        <div style="display:flex; flex-direction:column; gap:8px; margin-top:6px;">
          <div style="display:flex; gap:6px;">
            <button class="btn-secondary" id="btnImportCache" type="button" style="flex:1;">å¯¼å…¥</button>
            <button class="btn-secondary" id="btnExportCache" type="button" style="flex:1;">å¯¼å‡º</button>
          </div>
          <input type="file" id="cacheFile" accept=".json" style="display:none" />
          <div id="cacheInfo" style="font-size:12px; color:#666;">è¯æ¡ï¼š0</div>
        </div>
      </div>

      <div>
        <div class="meta-title">è¿è¡Œæ—¥å¿—</div>
        <div class="log-panel" id="logPanel"></div>
      </div>
    </div>
  </section>

  <section class="reader-wrapper">
    <div class="reader-container" id="reader" style="color:#888; font-size:16px;">
      è¯‘æ–‡ç”Ÿæˆåç‚¹å‡»ä»»æ„æ±‰å­—æŸ¥çœ‹è¯¦æƒ…
    </div>
    <div class="translation-panel">
      <h3>ç™½è¯è¯‘æ–‡</h3>
      <div id="fullTranslation"></div>
    </div>
  </section>

  <div class="overlay" id="overlay"></div>
  <div class="bottom-sheet" id="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header" id="sheetHeader"></div>
    <div class="tabs">
      <div class="tab active" data-tab="context">å½“å‰ä¹‰</div>
      <div class="tab" data-tab="dict">å­—å…¸</div>
      <div class="tab" data-tab="origin">å­—æº</div>
    </div>
    <div class="sheet-body">
      <div id="tab-context" class="tab-content active"></div>
      <div id="tab-dict" class="tab-content"></div>
      <div id="tab-origin" class="tab-content"></div>
    </div>
  </div>

  <div class="settings-modal" id="settingsModal">
    <div class="modal-card">
      <h2 style="font-size:18px; margin-bottom:15px;">åŒæ ¸ API é…ç½®</h2>
      
      <div class="setting-group">
        <h4>1. ä¸»åŠ› API (è´Ÿè´£åˆ†æ/è¯ç»„/å­—å…¸)</h4>
        <div style="margin-top:10px;">
          <label style="font-size:12px;">Base URL</label>
          <input id="apiUrl" style="width:100%; padding:8px 10px; margin-top:4px;" />
        </div>
        <div style="margin-top:8px;">
          <label style="font-size:12px;">API Key</label>
          <input id="apiKey" type="password" style="width:100%; padding:8px 10px; margin-top:4px;" />
        </div>
        <div style="margin-top:8px;">
          <label style="font-size:12px;">æ¨¡å‹</label>
          <input id="apiModel" style="width:100%; padding:8px 10px; margin-top:4px;" />
        </div>
      </div>

      <div class="setting-group" style="background:#f4f9f4; border-color:#dbe6db;">
        <h4>2. ç‹¬ç«‹ç¿»è¯‘ API (å¯é€‰ï¼Œå¡«äº†åˆ™å¯ç”¨)</h4>
        <div style="font-size:11px; color:#666; margin-bottom:8px;">æ¨èä½¿ç”¨å…è´¹/ä½ä»·æ¨¡å‹(å¦‚DeepSeek)è¿›è¡Œçº¯ç¿»è¯‘ï¼ŒèŠ‚çœä¸»APIæˆæœ¬ã€‚</div>
        <div style="margin-top:10px;">
          <label style="font-size:12px;">ç¿»è¯‘ Base URL</label>
          <input id="transUrl" placeholder="ç•™ç©ºåˆ™ä½¿ç”¨ä¸»åŠ› API" style="width:100%; padding:8px 10px; margin-top:4px;" />
        </div>
        <div style="margin-top:8px;">
          <label style="font-size:12px;">ç¿»è¯‘ API Key</label>
          <input id="transKey" type="password" placeholder="ç•™ç©ºåˆ™ä½¿ç”¨ä¸»åŠ› API" style="width:100%; padding:8px 10px; margin-top:4px;" />
        </div>
        <div style="margin-top:8px;">
          <label style="font-size:12px;">ç¿»è¯‘æ¨¡å‹</label>
          <input id="transModel" placeholder="ä¾‹å¦‚ deepseek-ai/DeepSeek-V3" style="width:100%; padding:8px 10px; margin-top:4px;" />
        </div>
      </div>
      
      <div style="margin-top:10px;">
        <label style="font-size:12px;">åˆ†æ®µé•¿åº¦ (å­—æ•°)</label>
        <input id="apiChunk" type="number" placeholder="é»˜è®¤ 100" style="width:100%; padding:10px 12px; margin-top:6px;" />
        <div style="font-size:11px;color:#888;margin-top:2px;">å»ºè®® 80-200ã€‚å­—æ•°è¶Šå°‘è¶Šç¨³ï¼Œå­—æ•°è¶Šå¤šè¶Šå¿«ä½†æ˜“è¶…æ—¶ã€‚</div>
      </div>

      <div style="margin-top:20px; text-align:right;">
        <button class="btn-secondary" id="btnCloseSettings">å–æ¶ˆ</button>
        <button class="btn-primary" id="btnSaveSettings">ä¿å­˜é…ç½®</button>
      </div>
    </div>
  </div>

  <script>
    // =========================================================
    // å·¥å…· & çŠ¶æ€
    // =========================================================
    const $ = (s) => document.querySelector(s);
    const $$ = (s) => document.querySelectorAll(s);
    
    const store = {
      get() { try { return JSON.parse(localStorage.getItem("wenyan_cfg")) || {}; } catch { return {}; } },
      set(d) { localStorage.setItem("wenyan_cfg", JSON.stringify(d)); }
    };

    const logger = {
      el: null,
      clear() { if (!this.el) this.el = $("#logPanel"); this.el.innerHTML = ""; },
      log(msg, type) {
        if (!this.el) this.el = $("#logPanel");
        const div = document.createElement("div");
        div.style.color = type === "error" ? "red" : (type === "success" ? "green" : "#444");
        div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        this.el.appendChild(div);
        this.el.scrollTop = this.el.scrollHeight;
      }
    };

    const dictCacheKey = "wenyan_dict_v3";
    let dictCache = {};
    let batchQueue = [];
    let isRunning = false;
    let currentResult = null;

    // =========================================================
    // åˆå§‹åŒ– (Init)
    // =========================================================
    document.addEventListener("DOMContentLoaded", () => {
      dictCache = loadCache();
      updateCacheInfo();

      const cfg = store.get();
      // ä¸»é…ç½®
      $("#apiUrl").value = cfg.url || "https://api.xiaomimimo.com/v1/chat/completions";
      $("#apiKey").value = cfg.key || "";
      $("#apiModel").value = cfg.model || "mimo-v2-flash";
      $("#apiChunk").value = cfg.chunkSize || 100;
      
      // ç¿»è¯‘é…ç½®
      $("#transUrl").value = cfg.transUrl || "";
      $("#transKey").value = cfg.transKey || "";
      $("#transModel").value = cfg.transModel || "";

      resetButtons();

      $("#btnSettings").onclick = () => $("#settingsModal").classList.add("active");
      $("#btnCloseSettings").onclick = () => $("#settingsModal").classList.remove("active");
      $("#btnSaveSettings").onclick = () => {
        store.set({
          url: $("#apiUrl").value.trim(),
          key: $("#apiKey").value.trim(),
          model: $("#apiModel").value.trim(),
          chunkSize: parseInt($("#apiChunk").value.trim()) || 100,
          transUrl: $("#transUrl").value.trim(),
          transKey: $("#transKey").value.trim(),
          transModel: $("#transModel").value.trim()
        });
        $("#settingsModal").classList.remove("active");
        logger.log("é…ç½®å·²ä¿å­˜", "success");
      };

      $("#btnTranslate").onclick = () => processSingle($("#textInput").value);

      $("#btnBatchImport").onclick = () => {
        const fileInput = $("#batchFile");
        if(fileInput) fileInput.click();
      };
      $("#batchFile").onchange = handleFiles;
      
      $("#btnBatchStart").onclick = runBatch;

      $("#btnImportCache").onclick = () => $("#cacheFile").click();
      $("#cacheFile").onchange = handleCacheImport;
      $("#btnExportCache").onclick = () => download(dictCache, "wenyan_cache_export.json");

      $("#btnDownload").onclick = () => download(currentResult, "translation.json");

      $("#overlay").onclick = closeSheet;
      $$(".tab").forEach(t => t.onclick = () => switchTab(t.dataset.tab));
    });

    function resetButtons() {
      $("#btnTranslate").disabled = false;
      $("#btnBatchImport").disabled = false;
      $("#btnBatchStart").disabled = false;
    }

    // =========================================================
    // æ ¸å¿ƒï¼šåŒé˜¶æ®µå¤„ç†é€»è¾‘
    // =========================================================
    
    // æ–‡æœ¬æ¸…æ´— + åˆ†æ®µ
    function normalizeText(t) {
      let text = (t || "").replace(/^\uFEFF/, "");
      text = text.replace(/\r\n/g, "\n").replace(/\r/g, "\n");
      text = text.replace(/([ã€‚ï¼ï¼Ÿï¼›\!\?])\s*\n\s*([â€â€™"'])/g, "$1$2");
      text = text.replace(/([â€œâ€˜"'])\s*\n\s*/g, "$1");
      return text.trim();
    }

    function splitText(text) {
      const t = normalizeText(text);
      if (!t) return [];
      
      const cfg = store.get();
      const TARGET_LEN = parseInt(cfg.chunkSize) || 100;

      const rawLines = t.split(/\n+/).map(s => s.trim()).filter(Boolean);
      const chunks = [];
      
      rawLines.forEach(line => {
        const parts = line.split(/([ã€‚ï¼ï¼Ÿï¼›;?!\.][â€â€™"']?)/).reduce((acc, curr, idx, arr) => {
          if (idx % 2 === 0) {
            const punct = arr[idx + 1] || "";
            const s = (curr + punct).trim();
            if(s) acc.push(s);
          }
          return acc;
        }, []);

        let buffer = "";
        parts.forEach(p => {
          if ((buffer + p).length > TARGET_LEN) {
            if (buffer) chunks.push(buffer);
            buffer = p;
          } else {
            buffer += p;
          }
        });
        if (buffer) chunks.push(buffer);
      });
      return chunks;
    }

    async function processSingle(text, isAutoSave = false, fileName = "result") {
      const chunks = splitText(text);
      if (!chunks.length) return;
      
      const cfg = store.get();
      if (!cfg.key) return alert("è¯·è®¾ç½®ä¸» API Key");

      // åˆ¤æ–­åŒå¡æ¨¡å¼
      const dualMode = !!(cfg.transKey && cfg.transUrl);

      logger.clear();
      setStatus(dualMode ? "åŒæ ¸è¿è¡Œä¸­..." : "å•æ ¸å¤„ç†ä¸­...");
      $("#btnTranslate").disabled = true;
      
      const result = { sentences: [], dictionary: {} };

      try {
        for (let i = 0; i < chunks.length; i++) {
          const chunk = chunks[i];
          
          let transText = "";
          let analysisData = {};

          if (dualMode) {
             logger.log(`æ®µè½ ${i+1}/${chunks.length}ï¼šåŒAPIå¹¶å‘ (ç¿»è¯‘ + åˆ†æ)...`, "info");
             const [tResult, aResult] = await Promise.all([
                callTranslationOnly(chunk, cfg),
                callStage1AnalysisOnly(chunk, cfg)
             ]);
             transText = tResult;
             analysisData = aResult;
          } else {
             logger.log(`æ®µè½ ${i+1}/${chunks.length}ï¼šå•APIå…¨é‡å¤„ç†...`);
             const data = await callStage1Full(chunk, cfg);
             transText = data.trans;
             analysisData = data;
          }

          // å®¹é”™å¤„ç†ï¼šç¡®ä¿ tokens å­˜åœ¨ä¸”ä¸ä¸ºç©ºï¼Œå¦åˆ™é™çº§å¤„ç†
          const safeTokens = (analysisData.tokens && analysisData.tokens.length > 0) 
              ? analysisData.tokens 
              : chunk.split('').map(c => ({c, phrase:"", mean:""}));

          const words = safeTokens.map(t => ({
            c: t.c,
            phrase: t.phrase || "",
            mean: t.mean || "", 
            p: t.p || "",
            pMean: t.phrase_mean || "" 
          }));
          
          result.sentences.push({ orig: chunk, trans: transText, words });
          render(result); 

          const missingTokens = [];
          const missingPhrases = [];

          words.forEach(w => {
            if (w.c && !isPunctuation(w.c)) {
              if (!dictCache[w.c]) missingTokens.push(w.c);
              else result.dictionary[w.c] = asEntryArray(dictCache[w.c])[0];
            }
            if (w.phrase && w.phrase.length > 1) {
              if (!dictCache[w.phrase]) missingPhrases.push(w.phrase);
              else result.dictionary[w.phrase] = asEntryArray(dictCache[w.phrase])[0];
            }
          });

          const uniqueMissing = [...new Set([...missingTokens, ...missingPhrases])];

          if (uniqueMissing.length > 0) {
            logger.log(`æ®µè½ ${i+1}ï¼šå‘ç° ${uniqueMissing.length} ä¸ªæ–°è¯ï¼Œæ­£åœ¨æŸ¥é˜…å­—å…¸...`, "info");
            const newDicts = await callStage2(uniqueMissing, cfg);
            
            Object.entries(newDicts).forEach(([key, entry]) => {
              upsertCharEntry(key, entry);
              result.dictionary[key] = entry;
            });
            saveCache();
          } else {
            logger.log(`æ®µè½ ${i+1}ï¼šå…¨è¯å‘½ä¸­ç¼“å­˜ï¼Œè·³è¿‡å­—å…¸æŸ¥è¯¢`, "success");
          }

          if(i < chunks.length - 1) await new Promise(r => setTimeout(r, 1000));
        }

        currentResult = result;
        if (isAutoSave) download(result, `${fileName}.json`);
        setStatus("å°±ç»ª");
        logger.log("å…¨éƒ¨å®Œæˆ", "success");

      } catch (e) {
        logger.log("é”™è¯¯ï¼š" + e.message, "error");
        setStatus("å¤±è´¥");
      } finally {
        $("#btnTranslate").disabled = false;
      }
    }

    // =========================================================
    // API è°ƒç”¨å‡½æ•°ç¾¤ (å›å½’è‡ªç„¶è¯­è¨€Promptï¼ŒåŒ…å«å·¥ç¨‹çº¦æŸ)
    // =========================================================

    // 1. ç‹¬ç«‹ç¿»è¯‘ (Free LLM)
    async function callTranslationOnly(text, cfg) {
      const prompt = `å°†æ•´æ®µæ–‡è¨€æ–‡ç¿»è¯‘ä¸ºç™½è¯æ–‡ã€‚æ³¨æ„åªè¦ç™½è¯æ–‡ç¿»è¯‘ï¼Œä¸è¦å…¶ä»–çš„è§£é‡Šæˆ–è¯´æ˜ï¼Œæ ‡ç‚¹ç¬¦å·è¦ä¸€ä¸€å¯¹åº”;å¯¹äºäººåã€åœ°åã€å®˜èŒç­‰ç»“åˆå¥å­çš„è¯­å¢ƒè¿”å›è¯¦ç»†ä¿¡æ¯ï¼Œä¸è¦è¿”å›åŸæ–‡ä»¥åŠè¯‘æ–‡ä¹‹å¤–çš„å…¶ä»–ä¸œè¥¿`
      const transCfg = { url: cfg.transUrl, key: cfg.transKey, model: cfg.transModel || "deepseek-ai/DeepSeek-V3" };
      
      const res = await fetchWithRetry(transCfg, [
        { role: "system", content: prompt },
        { role: "user", content: text }
      ], false);

      if (typeof res === 'object' && res.translation) return res.translation;
      if (typeof res === 'string') return res;
      return JSON.stringify(res);
    }

    // 2. çº¯åˆ†æ (Main LLM - Dual Mode) - è¯­ä¹‰å¢å¼ºç‰ˆ
    async function callStage1AnalysisOnly(text, cfg) {
      const prompt = `ä½ æ˜¯ä¸€ä½ç²¾é€šå¤ä»£æ±‰è¯­çš„è®­è¯‚ä¸“å®¶ã€‚è¯·å¯¹æ–‡è¨€æ–‡è¿›è¡Œé€å­—æ‹†è§£å’Œè¯ç»„è¯†åˆ«ã€‚
ã€å½“å‰æ–‡ç« æ ‡é¢˜ã€‘ï¼š${fileName}
ã€è¾“å‡ºè¦æ±‚ã€‘
ä»…è¾“å‡ºä¸¥æ ¼çš„ JSON (æ—  Markdown)ï¼š{"tokens":[{"c":"åŸæ–‡å•å­—","p":"","mean":"å•å­—è¯­å¢ƒä¹‰","phrase":"è¯ç»„","phrase_mean":"è¯ç»„ä¹‰"}]}
ã€ä»»åŠ¡ç›®æ ‡ã€‘
1. é€å­—æ‹†è§£ï¼Œå¹¶**ç§¯æè¯†åˆ«è¯ç»„**ã€‚

ã€è¯ç»„è¯†åˆ«åŸåˆ™ã€‘ï¼š
1. **è¯†åˆ«èŒƒå›´**ï¼šè¯·è¯†åˆ«æ–‡ä¸­æ‰€æœ‰çš„â€œå›ºå®šæ­é…â€ã€â€œåŒéŸ³èŠ‚è¯â€ã€â€œæˆè¯­â€ã€â€œè¿è¯â€ã€â€œä¸“æœ‰åè¯â€ä»¥åŠâ€œç‰¹æŒ‡çš„æ•°é‡ç»“æ„/åº¦é‡è¡¡â€ã€‚äººåã€åœ°åã€å®˜èŒã€æˆè¯­ã€å…¸æ•…ã€ç´§å¯†çš„åŒéŸ³èŠ‚åè¯/åŠ¨è¯,å¯¹äºå•å­—åè¯ï¼ˆäººåï¼Œåœ°åï¼Œå®˜å,æˆ–ç§°è°“ç­‰ï¼‰ä¸€å®šè¦æ ¹æ®è¯­å¢ƒå‡ºå¤„è¿”å›è¯¦ç»†é‡Šä¹‰ï¼Œæˆ–é”šå®šäººç‰©å…¸æ•…ç­‰
2. **åˆ¤å®šæ ‡å‡†**ï¼šå‡¡æ˜¯ä¸¤ä¸ªæˆ–ä»¥ä¸Šæ±‰å­—ç»“åˆç´§å¯†ï¼Œè¡¨è¾¾ä¸€ä¸ªå®Œæ•´æ¦‚å¿µï¼ˆå¦‚ä¸€ä¸ªåç‰©ã€ä¸€ä¸ªåŠ¨ä½œã€ä¸€ç§çŠ¶æ€ï¼‰çš„ï¼Œéƒ½åº”è§†ä¸ºè¯ç»„ã€‚
3. **ğŸš« ç¦æ­¢è¯†åˆ«**ï¼š
   - ç¦æ­¢å°†â€œä¸»è°“ç»“æ„â€æˆ–â€œåŠ¨å®¾çŸ­è¯­â€æ ‡è®°ä¸ºè¯ç»„ï¼ˆå¦‚ï¼š"å…¬æ›°"ã€"å§œæ°æ¬²ä¹‹" âŒï¼‰ã€‚
   - ç¦æ­¢åŒ…å«å¥æœ«è¯­æ°”è¯çš„å¥å­ï¼ˆå¦‚ï¼š"å›½ä¹‹å®³ä¹Ÿ"ã€"éš¾å›¾ä¹Ÿ" âŒï¼‰ã€‚
   - ç¦æ­¢æ¾æ•£çš„åŠ©è¯çŸ­è¯­ï¼ˆå¦‚ï¼š"ä¹‹å®³" âŒï¼‰ã€‚
//ã€æ ¸å¿ƒè§„åˆ™ã€‘
//1. **ä¸¥æ ¼å¯¹é½**ï¼štokens æ•°ç»„é•¿åº¦å¿…é¡»ä¸åŸæ–‡å­—ç¬¦æ•°ï¼ˆå«æ ‡ç‚¹ç©ºç™½ï¼‰å®Œå…¨ä¸€è‡´ã€‚æ ‡ç‚¹/ç©ºç™½çš„å±æ€§ç•™ç©ºã€‚
//2. **è¯ç»„è¯†åˆ«**ï¼š
//   - âœ… **ç§¯æåˆå¹¶**ï¼šå‡¡æ˜¯ä¸¤ä¸ªåŠä»¥ä¸Šæ±‰å­—ç»“åˆç´§å¯†ã€è¡¨è¾¾ä¸€ä¸ªå®Œæ•´æ¦‚å¿µçš„ï¼Œéƒ½åº”æ ‡è®°ä¸º phraseã€‚å•å­—ä¸æ˜¯è¯ç»„
//   - **å¿…é¡»åŒ…å«**ï¼šäººåï¼ˆå¦‚å…¬çˆ¶æ–‡ä¼¯ï¼‰ã€åœ°åã€å®˜èŒã€æˆè¯­ã€åŠŸèƒ½è™šè¯ï¼ˆæ—¢è€Œï¼‰ã€ä»¥åŠ**çŠ¶æ€åŠ¨ä½œè¯**ï¼ˆå¦‚ï¼šæ–¹ç»©ã€æ–¹å…´ã€æœªæ—¢ã€é€€æœï¼‰ã€‚
//   - **ä¸€è‡´æ€§**ï¼šåŒè¯ç»„å†…çš„å­—ï¼Œphrase å’Œ phrase_mean å¿…é¡»å®Œå…¨ç›¸åŒã€‚
//   - **å‡¡æ˜¯ä¸¤ä¸ªæˆ–ä»¥ä¸Šæ±‰å­—ç»“åˆç´§å¯†ï¼Œè¡¨è¾¾ä¸€ä¸ªå®Œæ•´æ¦‚å¿µï¼ˆå¦‚ä¸€ä¸ªåç‰©ã€ä¸€ä¸ªåŠ¨ä½œã€ä¸€ç§çŠ¶æ€ï¼‰çš„ï¼Œéƒ½åº”è§†ä¸ºè¯ç»„ã€‚
//   - **è¯·è¯†åˆ«æ–‡ä¸­æ‰€æœ‰çš„â€œå›ºå®šæ­é…â€ã€â€œåŒéŸ³èŠ‚è¯â€ã€â€œæˆè¯­â€ã€â€œè¿è¯â€ã€â€œä¸“æœ‰åè¯â€ä»¥åŠâ€œç‰¹æŒ‡çš„æ•°é‡ç»“æ„/åº¦é‡è¡¡â€ã€‚äººåã€åœ°åã€å®˜èŒã€æˆè¯­ã€å…¸æ•…ã€ç´§å¯†çš„åŒéŸ³èŠ‚åè¯/åŠ¨è¯å¹¶è¿”å›è¯¦ç»†é‡Šä¹‰
//3. **å­—ä¹‰ç²¾åº¦ï¼ˆå…³é”®ï¼‰**ï¼š
//   - **mean** å­—æ®µå¿…é¡»è§£é‡Š**è¯¥å•å­—**åœ¨å¥ä¸­çš„å…·ä½“å«ä¹‰ã€‚
//   - **ç¦æ­¢å¤åˆ¶**ï¼šå¦‚æœè¯¥å­—å±äºè¯ç»„ï¼Œmean **ç¦æ­¢**ç›´æ¥å¤åˆ¶ phrase_meanï¼Œå¿…é¡»è§£é‡Šå®ƒä½œä¸ºæ„è¯æˆåˆ†çš„æ„æ€ã€‚ï¼ˆä¾‹å¦‚ï¼šâ€œæ˜æœˆâ€ä¸­ï¼Œâ€œæ˜â€çš„ mean åº”ä¸ºâ€œæ˜äº®â€ï¼Œä¸å¯ä¸ºâ€œæœˆäº®â€ï¼›â€œæœˆâ€çš„ mean ä¸ºâ€œæœˆäº®â€ï¼‰ã€‚
//   - **å¯¹äºå•å­—åè¯ï¼ˆäººåï¼Œåœ°åï¼Œå®˜åç­‰ï¼‰ä¸€å®šè¦æ ¹æ®è¯­å¢ƒè¿”å›è¯¦ç»†é‡Šä¹‰
//4. **æ— éœ€ç¿»è¯‘**ï¼šæœ¬æ¬¡ä»»åŠ¡ä¸“æ³¨äºå­—ä¹‰åˆ†æã€‚`;
      
      return await fetchWithRetry(cfg, [
        { role: "system", content: prompt },
        { role: "user", content: text }
      ], true);
    }

    // 3. å…¨é‡æ¨¡å¼ (Main LLM - Single Mode) - è¯­ä¹‰å¢å¼ºç‰ˆ
    async function callStage1Full(text, cfg) {
      const prompt = `ä½ æ˜¯ä¸€ä½ç²¾é€šå¤ä»£æ±‰è¯­çš„è®­è¯‚ä¸“å®¶ã€‚è¯·å°†è¾“å…¥çš„æ–‡è¨€æ–‡è½¬æ¢ä¸ºç»“æ„åŒ–æ•°æ®ã€‚
ã€è¾“å‡ºè¦æ±‚ã€‘
ä»…è¾“å‡ºä¸¥æ ¼çš„ JSON (æ—  Markdown)ï¼š{"trans":"å…¨æ®µç™½è¯ç›´è¯‘","tokens":[{"c":"åŸæ–‡å•å­—","p":"","mean":"å•å­—è¯­å¢ƒä¹‰","phrase":"è¯ç»„","phrase_mean":"è¯ç»„ä¹‰"}]}

ã€æ ¸å¿ƒè§„åˆ™ã€‘
1. **ä¸¥æ ¼å¯¹é½**ï¼štokens æ•°ç»„é•¿åº¦å¿…é¡»ä¸åŸæ–‡å­—ç¬¦æ•°ï¼ˆå«æ ‡ç‚¹ç©ºç™½ï¼‰å®Œå…¨ä¸€è‡´ã€‚æ ‡ç‚¹/ç©ºç™½çš„å±æ€§ç•™ç©ºã€‚
2. **è¯ç»„è¯†åˆ«**ï¼š
   - âœ… **ç§¯æåˆå¹¶**ï¼šå‡¡æ˜¯ä¸¤ä¸ªåŠä»¥ä¸Šæ±‰å­—ç»“åˆç´§å¯†ã€è¡¨è¾¾ä¸€ä¸ªå®Œæ•´æ¦‚å¿µçš„ï¼Œéƒ½åº”æ ‡è®°ä¸º phraseã€‚è¯·è¯†åˆ«æ–‡ä¸­æ‰€æœ‰çš„â€œå›ºå®šæ­é…â€ã€â€œåŒéŸ³èŠ‚è¯â€ã€â€œæˆè¯­â€ã€â€œè¿è¯â€ã€â€œä¸“æœ‰åè¯â€ä»¥åŠâ€œç‰¹æŒ‡çš„æ•°é‡ç»“æ„/åº¦é‡è¡¡â€ã€‚äººåã€åœ°åã€å®˜èŒã€æˆè¯­ã€å…¸æ•…ã€ç´§å¯†çš„åŒéŸ³èŠ‚åè¯/åŠ¨è¯
   - **å¿…é¡»åŒ…å«**ï¼šäººåï¼ˆå¦‚å…¬çˆ¶æ–‡ä¼¯ï¼‰ã€åœ°åã€å®˜èŒã€æˆè¯­ã€åŠŸèƒ½è™šè¯ï¼ˆæ—¢è€Œï¼‰ã€ä»¥åŠ**çŠ¶æ€åŠ¨ä½œè¯**ï¼ˆå¦‚ï¼šæ–¹ç»©ã€æ–¹å…´ã€æœªæ—¢ã€é€€æœï¼‰ã€‚å¯¹ä¸“ç”¨åå­—å¦‚äººååœ°åï¼Œè¦è”ç³»ä¸Šä¸‹æ–‡è¿”å›è¾ƒè¯¦ç»†çš„é‡Šä¹‰
   - **ä¸€è‡´æ€§**ï¼šåŒè¯ç»„å†…çš„å­—ï¼Œphrase å’Œ phrase_mean å¿…é¡»å®Œå…¨ç›¸åŒã€‚
3. **å­—ä¹‰ç²¾åº¦ï¼ˆå…³é”®ï¼‰**ï¼š
   - **mean** å­—æ®µå¿…é¡»è§£é‡Š**è¯¥å•å­—**åœ¨å¥ä¸­çš„å…·ä½“é‡Šä¹‰ï¼Œè”ç³»ä¸Šä¸‹æ–‡å’Œè¯­å¢ƒç»™å‡ºæ¯ä¸ªå­—åœ¨å¥å­é‡Œçš„é‡Šä¹‰
   - **ç¦æ­¢å¤åˆ¶**ï¼šå¦‚æœè¯¥å­—å±äºè¯ç»„ï¼Œmean **ç¦æ­¢**ç›´æ¥å¤åˆ¶ phrase_meanï¼Œå¿…é¡»è§£é‡Šå®ƒä½œä¸ºæ„è¯æˆåˆ†çš„æ„æ€ã€‚ï¼ˆä¾‹å¦‚ï¼šâ€œæ˜æœˆâ€ä¸­ï¼Œâ€œæ˜â€çš„ mean åº”ä¸ºâ€œæ˜äº®â€ï¼Œä¸å¯ä¸ºâ€œæœˆäº®â€ï¼‰ã€‚
4. **å…¨æ®µç¿»è¯‘**ï¼štrans å­—æ®µå¿…é¡»æä¾›å…¨æ®µé€šé¡ºæµç•…çš„ç°ä»£æ±‰è¯­ç›´è¯‘ã€‚`;

      return await fetchWithRetry(cfg, [
        { role: "system", content: prompt },
        { role: "user", content: text }
      ], true);
    }

    // 4. å­—å…¸æŸ¥è¯¢ (Main LLM)
    async function callStage2(terms, cfg) {
      const listStr = terms.join("ã€");
      const prompt = `ä½ æ˜¯ä¸€éƒ¨æ–‡è¨€æ–‡è¯å…¸ã€‚è¯·ä¸ºä»¥ä¸‹ç”Ÿå­—/è¯æä¾›ã€æ ‡å‡†å­—å…¸é‡Šä¹‰ã€‘ã€‚
ç”Ÿè¯åˆ—è¡¨ï¼š${listStr}

è¿”å›ä¸¥æ ¼ JSONï¼ŒKey æ˜¯ç”Ÿè¯ï¼ŒValue æ˜¯è¯¦æƒ…ï¼š
{
  "å­—æˆ–è¯": {
    "p": "æ‹¼éŸ³",
    "pos": "è¯æ€§",
    "g": "å®Œæ•´é‡Šä¹‰åˆ—è¡¨(å¤šä¹‰é¡¹ç”¨åˆ†å·éš”å¼€)",
    "ety": { "origin": "å­—æº/å‡ºå¤„", "type": "é€ å­—æ³•" }
  }
}
æ³¨æ„ï¼šety å­—æ®µä»…å•å­—éœ€è¦ã€‚`;

      return await fetchWithRetry(cfg, [
        { role: "system", content: prompt },
        { role: "user", content: "è¯·ç”Ÿæˆå­—å…¸æ•°æ®ã€‚" }
      ], true);
    }

    // ---------------------------------------------------------
    // é€šç”¨ç½‘ç»œè¯·æ±‚ (é€‚é… Mimo/OpenAI Header)
    // ---------------------------------------------------------
    async function fetchWithRetry(cfg, messages, expectJson = true, retries = 3) {
      const body = {
        model: cfg.model,
        messages: messages,
        temperature: 0.1,
        stream: false,
        thinking: { type: "disabled" } // é˜²æ­¢ Mimo æŠ¥é”™
      };

      // é Mimo æ¥å£æ‰åŠ  JSON æ ¼å¼é™åˆ¶
      if (expectJson && !cfg.url.includes("xiaomimimo")) {
        body.response_format = { type: "json_object" };
      }

      for (let i = 0; i < retries; i++) {
        try {
          const controller = new AbortController();
          const id = setTimeout(() => controller.abort(), 300000); 
          
          // æ™ºèƒ½ Header åˆ‡æ¢
          const headers = { "Content-Type": "application/json" };
          if (cfg.url.includes("xiaomimimo")) {
            headers["api-key"] = cfg.key;
          } else {
            headers["Authorization"] = `Bearer ${cfg.key}`;
          }

          const res = await fetch(cfg.url, {
            method: "POST",
            headers: headers,
            body: JSON.stringify(body),
            signal: controller.signal
          });
          clearTimeout(id);
          
          if (!res.ok) {
             const txt = await res.text();
             throw new Error(`HTTP ${res.status}: ${txt.slice(0, 50)}`);
          }
          const data = await res.json();
          let content = data.choices?.[0]?.message?.content || "";

          if (expectJson) return safeJsonParse(content);
          return content;

        } catch (e) {
          if (i === retries - 1) throw e;
          logger.log(`è¯·æ±‚é‡è¯• (${i+1}/${retries})...`, "info");
          await new Promise(r => setTimeout(r, 2000));
        }
      }
    }

    // =========================================================
    // ç¼“å­˜ä¸é€šç”¨
    // =========================================================
    function isPunctuation(char) { return /[\u3000\sï¼Œã€‚ï¼Ÿï¼ï¼›ï¼šâ€œâ€â€˜â€™ã€ã€Šã€‹ã€ˆã€‰â€”â€”â€¦\-,.?!;:(){}[\]"']/.test(char); }
    
    function safeJsonParse(text) {
      try { return JSON.parse(text); } catch {}
      const clean = text.replace(/^```json\s*/i, "").replace(/```$/g, "").trim();
      try { return JSON.parse(clean); } catch {}
      return { tokens: [] };
    }

    function loadCache() { try { return JSON.parse(localStorage.getItem(dictCacheKey)||"{}"); } catch { return {}; } }
    function saveCache() { localStorage.setItem(dictCacheKey, JSON.stringify(dictCache)); updateCacheInfo(); }
    function updateCacheInfo() { $("#cacheInfo").textContent = `è¯æ¡ï¼š${Object.keys(dictCache).length}`; }
    function setStatus(s) { $("#statusPill").textContent = s; }

    function asEntryArray(v) {
      if (!v) return [];
      if (Array.isArray(v)) return v;
      return [v];
    }

    function upsertCharEntry(key, entry) {
      if (!key || !entry) return;
      const arr = asEntryArray(dictCache[key]);
      const exists = arr.some(e => e.p === entry.p && e.g === entry.g);
      if (!exists) {
        arr.unshift(entry); 
        dictCache[key] = arr;
      }
    }

    function handleCacheImport(e) {
      const file = e.target.files?.[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        try { Object.assign(dictCache, JSON.parse(ev.target.result)); saveCache(); alert("å¯¼å…¥æˆåŠŸ"); } catch{ alert("æ ¼å¼é”™è¯¯"); }
      };
      reader.readAsText(file);
      e.target.value = "";
    }

    // =========================================================
    // æ‰¹é‡ (å¤ç”¨ processSingle)
    // =========================================================
    function handleFiles(e) {
      const files = Array.from(e.target.files||[]);
      files.forEach(f => {
        if(!f.name.endsWith(".txt")) return;
        const r = new FileReader();
        r.onload = ev => { batchQueue.push({name: f.name, text: normalizeText(ev.target.result)}); renderBatchList(); };
        r.readAsText(f);
      });
      e.target.value = "";
    }
    function renderBatchList() {
      $("#batchFiles").style.display = batchQueue.length ? "block" : "none";
      $("#batchFiles").innerHTML = batchQueue.map((f,i) => 
        `<div class="batch-item"><span>${escapeHtml(f.name)}</span><button onclick="removeBatch(${i})">åˆ é™¤</button></div>`
      ).join("");
      $("#batchInfo").textContent = batchQueue.length ? `å¾…å¤„ç†ï¼š${batchQueue.length}` : "æœªå¯¼å…¥";
    }
    window.removeBatch = (i) => {
      batchQueue.splice(i, 1);
      renderBatchList();
    };

    async function runBatch() {
      if(isRunning || !batchQueue.length) return;
      const cfg = store.get();
      if(!cfg.key) return alert("API Key Missing");
      isRunning = true;
      $("#btnBatchStart").disabled = true;
      $("#btnBatchImport").disabled = true; 
      try {
        for(let i=0; i<batchQueue.length; i++) {
          logger.log(`æ‰¹é‡å¤„ç†ï¼š${batchQueue[i].name}`);
          await processSingle(batchQueue[i].text, true, batchQueue[i].name.replace(".txt",""));
        }
        alert("æ‰¹é‡å®Œæˆ");
      } finally {
        isRunning = false;
        $("#btnBatchStart").disabled = false;
        $("#btnBatchImport").disabled = false; 
        batchQueue = [];
        renderBatchList();
      }
    }

    // =========================================================
    // UI æ¸²æŸ“
    // =========================================================
    function render(data) {
      $("#reader").innerHTML = "";
      $("#fullTranslation").innerHTML = "";
      data.sentences.forEach(s => {
        const p = document.createElement("p");
        p.className = "reader-line";
        s.words.forEach(w => {
          const span = document.createElement("span");
          span.textContent = w.c;
          if(isPunctuation(w.c)) span.className = "punct";
          else {
            span.className = "char";
            span.onclick = () => openDetail(span, w, s, data.dictionary);
          }
          p.appendChild(span);
        });
        $("#reader").appendChild(p);
        $("#fullTranslation").innerHTML += `<p>${escapeHtml(s.trans)}</p>`;
      });
    }

    function openDetail(el, word, sentence, dict) {
      $$(".char.active").forEach(n=>n.classList.remove("active"));
      el.classList.add("active");

      const cachedEntry = dict[word.c] || {}; 
      const phraseEntry = word.phrase ? (dict[word.phrase] || {}) : null;

      $("#sheetHeader").innerHTML = `
        <span class="big-char">${escapeHtml(word.c)}</span>
        <span class="pinyin">[ ${escapeHtml(word.p || cachedEntry.p || "")} ]</span>
        <span class="radical">${escapeHtml(cachedEntry.pos || "")}</span>
      `;

      $("#tab-context").innerHTML = `
        <div class="context-meaning">
          <div class="context-term">å•å­—ï¼š${escapeHtml(word.c)}</div>
          <div class="context-def"><b>å½“å‰ä¹‰ï¼š</b>${escapeHtml(word.mean || "æš‚æ— ")}</div>
        </div>
        ${word.phrase ? `
        <div class="context-meaning">
          <div class="context-term">è¯ç»„ï¼š${escapeHtml(word.phrase)}</div>
          <div class="context-def"><b>å½“å‰ä¹‰ï¼š</b>${escapeHtml(word.pMean || "æš‚æ— ")}</div>
        </div>` : ''}
        <div class="translation-box">
          <b>åŸå¥ï¼š</b>${escapeHtml(sentence.orig)}<br>
          <b>è¯‘æ–‡ï¼š</b>${escapeHtml(sentence.trans)}
        </div>
      `;

      let dictHtml = "";
      if (phraseEntry && phraseEntry.g) {
         dictHtml += `<div class="dict-list-item"><b>ã€${word.phrase}ã€‘</b><br>${formatDictText(phraseEntry.g)}</div><hr style="margin:10px 0;border:0;border-top:1px dashed #eee;">`;
      }
      dictHtml += `<div class="dict-list-item"><b>ã€${word.c}ã€‘</b><br>${formatDictText(cachedEntry.g)}</div>`;
      
      $("#tab-dict").innerHTML = dictHtml || "æš‚æ— å­—å…¸æ•°æ®";

      const ety = cachedEntry.ety || {};
      $("#tab-origin").innerHTML = `
        <div class="context-meaning">
           <div class="evo-char font-oracle" style="font-size:32px;text-align:center;margin:10px auto;">${escapeHtml(word.c)}</div>
           <p><b>æ¥æºï¼š</b>${escapeHtml(ety.origin || "æš‚æ— ")}</p>
           <p><b>é€ å­—ï¼š</b>${escapeHtml(ety.type || "æš‚æ— ")}</p>
        </div>
      `;

      $("#sheet").classList.add("show");
      $("#overlay").classList.add("show");
      switchTab("context");
    }

    function formatDictText(text) {
      if(!text) return "æš‚æ— ";
      return escapeHtml(text).replace(/[ï¼›;]/g, "<br>â€¢ ");
    }

    function switchTab(n) {
      $$(".tab").forEach(t => t.classList.toggle("active", t.dataset.tab === n));
      $$(".tab-content").forEach(c => c.classList.toggle("active", c.id === `tab-${n}`));
    }
    function closeSheet() { $("#sheet").classList.remove("show"); $("#overlay").classList.remove("show"); $$(".char.active").forEach(n=>n.classList.remove("active")); }
    function download(d, n) { if(!d)return; const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([JSON.stringify(d,null,2)])); a.download = n; a.click(); }
    function escapeHtml(s) { return String(s||"").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }
  </script>
</body>
</html>
